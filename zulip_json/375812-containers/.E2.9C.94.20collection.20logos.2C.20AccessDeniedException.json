[
    {
        "content": "<p>If you try to upload a logo to a collection you get this error: java.nio.file.AccessDeniedException: /opt/payara/../docroot</p>",
        "id": 366606399,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1686857661
    },
    {
        "content": "<p>Originally reported here: <a href=\"https://github.com/IQSS/dataverse-docker/issues/85#issuecomment-1590391145\">https://github.com/IQSS/dataverse-docker/issues/85#issuecomment-1590391145</a></p>",
        "id": 366606452,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1686857674
    },
    {
        "content": "<p>[#|2023-06-15T19:31:50.220+0000|WARNING|Payara 5.2022.5|javax.enterprise.resource.webcontainer.jsf.lifecycle|_ThreadID=99;_ThreadName=http-thread-pool::http-listener-1(4);_TimeMillis=1686857510220;_LevelValue=900;|<br>\n  /themeAndWidgetsFragment.xhtml @58,239 listener=\"#{themeWidgetFragment.handleImageFileUpload}\": java.lang.RuntimeException: Error creating temp directory<br>\njavax.el.ELException: /themeAndWidgetsFragment.xhtml @58,239 listener=\"#{themeWidgetFragment.handleImageFileUpload}\": java.lang.RuntimeException: Error creating temp directory<br>\n...<br>\nCaused by: java.lang.RuntimeException: Error creating temp directory<br>\n    at edu.harvard.iq.dataverse.ThemeWidgetFragment.createTempDir(ThemeWidgetFragment.java:96)<br>\n    at edu.harvard.iq.dataverse.ThemeWidgetFragment.handleImageFileUpload(ThemeWidgetFragment.java:249)<br>\n...<br>\nCaused by: java.nio.file.AccessDeniedException: /opt/payara/../docroot</p>",
        "id": 366606753,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1686857755
    },
    {
        "content": "<p>Here's line 96 above: <a href=\"https://github.com/IQSS/dataverse/blob/9feb865e9fc67ea6ba027cc36e7dbafef1301085/src/main/java/edu/harvard/iq/dataverse/ThemeWidgetFragment.java#L96\">https://github.com/IQSS/dataverse/blob/9feb865e9fc67ea6ba027cc36e7dbafef1301085/src/main/java/edu/harvard/iq/dataverse/ThemeWidgetFragment.java#L96</a></p>",
        "id": 366607169,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1686857874
    },
    {
        "content": "<p>Related is the note about collection logos at <a href=\"https://guides.dataverse.org/en/5.13/installation/advanced.html#multiple-app-servers\">https://guides.dataverse.org/en/5.13/installation/advanced.html#multiple-app-servers</a></p>",
        "id": 366607346,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1686857916
    },
    {
        "content": "<p>I created <a href=\"https://github.com/IQSS/dataverse/issues/9662\">https://github.com/IQSS/dataverse/issues/9662</a> for this.</p>",
        "id": 367844566,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687250361
    },
    {
        "content": "<p>Some poor hardcoded design choices in there...</p>",
        "id": 367844662,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687250380
    },
    {
        "content": "<p>Starting hacking on a PR to resolve the tech debt</p>",
        "id": 367844885,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687250417
    },
    {
        "content": "<p>Perfect! Thanks for taking a look!</p>",
        "id": 367872556,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687256343
    },
    {
        "content": "<p>Course!</p>",
        "id": 367872670,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687256369
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> <span class=\"user-mention\" data-user-id=\"598186\">@Don Sizemore</span> I'm tempted to add the idea expressed in <a href=\"https://github.com/IQSS/dataverse/issues/9572\">https://github.com/IQSS/dataverse/issues/9572</a> to the scope of this, as we need to check for these configured folders... Would it make sense to combine this?</p>",
        "id": 367875316,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687256928
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> I think checking for the existence (and ownership/mode) of necessary directories on service launch is a good thing to add.</p>",
        "id": 367895322,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1687261255
    },
    {
        "content": "<p>At the very least log an error about missing directories, I'd say</p>",
        "id": 367919950,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687266315
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598186\">@Don Sizemore</span> <span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> here's the first version of this config checking: <a href=\"https://github.com/poikilotherm/dataverse/commit/a4ec3a66e76aa1559aea0c05cedc2da2b38d7b03\">https://github.com/poikilotherm/dataverse/commit/a4ec3a66e76aa1559aea0c05cedc2da2b38d7b03</a></p>",
        "id": 368263901,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687358814
    },
    {
        "content": "<p>It does fail deployment on startup if some check is not successful</p>",
        "id": 368264102,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687358852
    },
    {
        "content": "<p>Looks good! I bet the error messages are informative.</p>\n<p><code>@DependsOn(\"StartupFlywayMigrator\")</code> means it gets run after flyway, I assume.</p>",
        "id": 368264891,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687359004
    },
    {
        "content": "<p>I tried to make it as decriptive as possible, even add hints about the JVM setting names</p>",
        "id": 368265301,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687359091
    },
    {
        "content": "<p>Yeah, it happens after Flyway</p>",
        "id": 368265380,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687359103
    },
    {
        "content": "<p>Which also means you will see all those Flyway messages... So you need to scroll up up up up to see the log messages...</p>",
        "id": 368265614,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687359139
    },
    {
        "content": "<p>There's not really a way around that - I'd prefer to have the checking run after flyway if we use it later for DB settings that might need a migration some day.</p>",
        "id": 368265879,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687359184
    },
    {
        "content": "<p>I guess I'm used to scrolling up. No big deal. <span aria-label=\"happy\" class=\"emoji emoji-1f600\" role=\"img\" title=\"happy\">:happy:</span></p>",
        "id": 368267128,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687359375
    },
    {
        "content": "<p>Green light from me. Wanna run it by #dv-tech?</p>",
        "id": 368267673,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687359482
    },
    {
        "content": "<p>Gimme a sec. Still need to hack the docroot bit</p>",
        "id": 368267803,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687359500
    },
    {
        "content": "<p>At least now we can verify things are present and we don't fall over strange configs.</p>",
        "id": 368268038,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687359547
    },
    {
        "content": "<p>Who knows, maybe we can add additional pre-flight checks in the future <span aria-label=\"airplane\" class=\"emoji emoji-2708\" role=\"img\" title=\"airplane\">:airplane:</span></p>",
        "id": 368272712,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687360387
    },
    {
        "content": "<p>Yeah I'd love this!</p>",
        "id": 368278471,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687361400
    },
    {
        "content": "<p>There's got to be a flotation/float dad joke here.</p>",
        "id": 368283115,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687362219
    },
    {
        "content": "<p>I'm getting there... Lots of places in the code where things are hardcoded where the docroot shall be. Good to change all of them...</p>",
        "id": 368299052,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687365236
    },
    {
        "content": "<p>Oh isn't it just great... <span aria-label=\"angry\" class=\"emoji emoji-1f620\" role=\"img\" title=\"angry\">:angry:</span></p>",
        "id": 368474247,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424209
    },
    {
        "content": "<p>Now I found just another bug in Payara</p>",
        "id": 368474288,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424218
    },
    {
        "content": "<p>But this time it's failing big time</p>",
        "id": 368474355,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424231
    },
    {
        "content": "<p>They are using a regex approach for variable substitution in web.xml and other files...</p>",
        "id": 368474568,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424274
    },
    {
        "content": "<p>(<a href=\"https://github.com/payara/Payara/blob/payara-server-5.2022.5/nucleus/admin/config-api/src/main/java/org/glassfish/config/support/TranslatedConfigView.java\">https://github.com/payara/Payara/blob/payara-server-5.2022.5/nucleus/admin/config-api/src/main/java/org/glassfish/config/support/TranslatedConfigView.java</a> for the curious ones)</p>",
        "id": 368474687,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424285
    },
    {
        "content": "<p>Which means <code>${MPCONFIG=dataverse.files.docroot:${ENV=STORAGE_DIR:.}/docroot}</code> is taken apart with their regexes by cutting of <code>/docroot</code> after the second last bracket.</p>",
        "id": 368475153,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424350
    },
    {
        "content": "<p>Gnaaaah</p>",
        "id": 368475204,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424358
    },
    {
        "content": "<p>I can't <em>believe</em> nobody actually tested this</p>",
        "id": 368475270,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424373
    },
    {
        "content": "<p>Yeah well... Their tests don't cover recursive usage. <span aria-label=\"rolling eyes\" class=\"emoji emoji-1f644\" role=\"img\" title=\"rolling eyes\">:rolling_eyes:</span>  <a href=\"https://github.com/payara/Payara/blob/payara-server-5.2022.5/nucleus/admin/config-api/src/test/java/org/glassfish/config/support/TranslatedValueTest.java\">https://github.com/payara/Payara/blob/payara-server-5.2022.5/nucleus/admin/config-api/src/test/java/org/glassfish/config/support/TranslatedValueTest.java</a></p>",
        "id": 368476276,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424552
    },
    {
        "content": "<p>But maybe they just forgot to add \"no deep nesting allowed\" in their docs... <a href=\"https://docs.payara.fish/community/docs/Technical%20Documentation/Payara%20Server%20Documentation/Server%20Configuration%20And%20Management/Configuration%20Options/Variable%20Substitution/Types%20of%20Variables.html\">https://docs.payara.fish/community/docs/Technical%20Documentation/Payara%20Server%20Documentation/Server%20Configuration%20And%20Management/Configuration%20Options/Variable%20Substitution/Types%20of%20Variables.html</a></p>",
        "id": 368477285,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424754
    },
    {
        "content": "<p>So this would be a new feature then...</p>",
        "id": 368477428,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687424771
    },
    {
        "content": "<p>Good times</p>",
        "id": 368490141,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687427185
    },
    {
        "content": "<p>Crazy idea: store collection logos in the database</p>",
        "id": 368490411,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687427237
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598112\">Philip Durbin</span> <a href=\"#narrow/stream/375812-containers/topic/collection.20logos.2C.20AccessDeniedException/near/368490411\">said</a>:</p>\n<blockquote>\n<p>Crazy idea: store collection logos in the database</p>\n</blockquote>\n<p>I support this!</p>",
        "id": 368926432,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1687532317
    },
    {
        "content": "<p>I don't - storing binary blobs in databases has never been a good idea.</p>",
        "id": 368929311,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1687532821
    },
    {
        "content": "<p>Ok ok. We'll figure it out. <span aria-label=\"stuck out tongue wink\" class=\"emoji emoji-1f61c\" role=\"img\" title=\"stuck out tongue wink\">:stuck_out_tongue_wink:</span></p>",
        "id": 368980744,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1687542981
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598183\">Oliver Bertuch</span> <a href=\"#narrow/stream/375812-containers/topic/collection.20logos.2C.20AccessDeniedException/near/368475153\">said</a>:</p>\n<blockquote>\n<p>Which means <code>${MPCONFIG=dataverse.files.docroot:${ENV=STORAGE_DIR:.}/docroot}</code> is taken apart with their regexes by cutting of <code>/docroot</code> after the second last bracket.</p>\n</blockquote>\n<p>I think I might have run into this one with dataverse-docker setup; we have a couple of logo's because logo's make management happy (c); I always, always end up copying them in the right spot with right permissions after upload and then it \"magically\" works.</p>",
        "id": 373862358,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1688976075
    },
    {
        "content": "<p>Yeah it's just great. I still didn't have the time to come around and file a bug report.</p>",
        "id": 373911643,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1688985841
    },
    {
        "content": "<p>Could add an env var to the image instead,  but it feels kind of dirty to me</p>",
        "id": 373911908,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1688985882
    },
    {
        "content": "<p>But probably the easiest workaround for now...</p>",
        "id": 373912204,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1688985935
    },
    {
        "content": "<p>Make it work, file a bug report, create a todo issue to get back to this in our image when resolved upstream</p>",
        "id": 373912405,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1688985970
    },
    {
        "content": "<p>So I created this: <a href=\"https://github.com/IQSS/dataverse/pull/9819\">https://github.com/IQSS/dataverse/pull/9819</a> But it will not be merged for 6.0. Will fight to get it merged for 6.1 as it is a blocker on containers. <span class=\"user-mention\" data-user-id=\"601950\">@Thomas van Erven</span></p>",
        "id": 386805046,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1692784452
    },
    {
        "content": "<p>Much obliged, I'll owe you a beer once it's solved (though it's honestly a minor amount of work to do so - the main amount of work is in debugging why logo's aren't showing in the first place)</p>",
        "id": 389341286,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1693978470
    },
    {
        "content": "<p><span aria-label=\"beer\" class=\"emoji emoji-1f37a\" role=\"img\" title=\"beer\">:beer:</span> <span aria-label=\"dissolve\" class=\"emoji emoji-1fae0\" role=\"img\" title=\"dissolve\">:dissolve:</span> - I'll be in for a coke <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 389343058,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1693979636
    },
    {
        "content": "<p>Yeah, I made the solution harder for myself by adding all the checks on startup... <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span></p>",
        "id": 389343156,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1693979683
    },
    {
        "content": "<p>Really we're just waiting for 6.0 to ship before we turn around attention to PRs like this. Thanks for your patience! I think we're close!</p>",
        "id": 389626542,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1694083688
    },
    {
        "content": "<p>Merged! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> Configurable docroot via MicroProfile Config <a href=\"https://github.com/IQSS/dataverse/issues/9819\">#9819</a></p>",
        "id": 396561023,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697225297
    },
    {
        "content": "<p>Works great!<br>\n<a href=\"/user_uploads/53090/okvCy7eh0fCgHI_0SZMmGcxb/Screenshot-2023-10-13-at-3.33.34-PM.png\">Screenshot-2023-10-13-at-3.33.34-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/okvCy7eh0fCgHI_0SZMmGcxb/Screenshot-2023-10-13-at-3.33.34-PM.png\" title=\"Screenshot-2023-10-13-at-3.33.34-PM.png\"><img src=\"/user_uploads/53090/okvCy7eh0fCgHI_0SZMmGcxb/Screenshot-2023-10-13-at-3.33.34-PM.png\"></a></div>",
        "id": 396561593,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697225638
    },
    {
        "content": "<p>Thanks, <img alt=\":dataverse_man:\" class=\"emoji\" src=\"https://zulip-avatars.s3.amazonaws.com/53090/emoji/images/44207.png\" title=\"dataverse man\"> <span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> <img alt=\":dataverse_man:\" class=\"emoji\" src=\"https://zulip-avatars.s3.amazonaws.com/53090/emoji/images/44207.png\" title=\"dataverse man\"> !</p>",
        "id": 396561674,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697225662
    },
    {
        "content": "<p>I _think_ this is solved now. Marking as such <span aria-label=\"smile cat\" class=\"emoji emoji-1f638\" role=\"img\" title=\"smile cat\">:smile_cat:</span></p>",
        "id": 396827741,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697435519
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598183\">Oliver Bertuch</span> has marked this topic as resolved.</p>",
        "id": 396827753,
        "sender_full_name": "Notification Bot",
        "timestamp": 1697435523
    }
]