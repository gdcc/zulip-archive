[
    {
        "content": "<p>I want to run a containerized Dataverse instance using a direct upload s3 storage. I want to run it pointing to a real AWS account and bucket, that is, without localstack and minio.</p>\n<p>I have used the microprofile config options for setting the AWS credentials (files.&lt;id&gt;.access-key and files.&lt;id&gt;.secret-key) and added them in the JVM_ARGS Dataverse env variable.</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"nt\">services</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nt\">test_dataverse</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">container_name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">'test_dataverse'</span>\n<span class=\"w\">    </span><span class=\"nt\">hostname</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">dataverse</span>\n<span class=\"w\">    </span><span class=\"nt\">image</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DATAVERSE_IMAGE_REGISTRY}/gdcc/dataverse:${DATAVERSE_IMAGE_TAG}</span>\n<span class=\"w\">    </span><span class=\"nt\">restart</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">on-failure</span>\n<span class=\"w\">    </span><span class=\"nt\">user</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">payara</span>\n<span class=\"w\">    </span><span class=\"nt\">environment</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_DB_HOST</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">postgres</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_DB_PASSWORD</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">secret</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_DB_USER</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DATAVERSE_DB_USER}</span>\n<span class=\"w\">      </span><span class=\"nt\">JVM_ARGS</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.storage-driver-id=file1</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.pid.providers=fake</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.pid.default-provider=fake</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.pid.fake.type=FAKE</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.pid.fake.label=FakeDOIProvider</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.pid.fake.authority=10.5072</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.pid.fake.shoulder=FK2/</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.type=s3</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.label=XXX</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.bucket-name=XXX</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.upload-redirect=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.download-redirect=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.ingestsizelimit=50000000</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.url-expiration-minutes=60</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.connection-pool-size=2048</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.access-key=XXX</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.secret-key=XXX</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\"># No mpconfig for region?</span>\n<span class=\"w\">    </span><span class=\"nt\">ports</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"s\">'8080:8080'</span>\n<span class=\"w\">    </span><span class=\"nt\">networks</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">dataverse</span>\n<span class=\"w\">    </span><span class=\"nt\">depends_on</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">test_postgres</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">test_solr</span>\n<span class=\"w\">    </span><span class=\"nt\">tmpfs</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/dumps:mode=770,size=2052M,uid=1000,gid=1000</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/tmp:mode=770,size=2052M,uid=1000,gid=1000</span>\n<span class=\"w\">    </span><span class=\"nt\">mem_limit</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">2147483648</span><span class=\"w\"> </span><span class=\"c1\"># 2 GiB</span>\n<span class=\"w\">    </span><span class=\"nt\">mem_reservation</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">1024m</span>\n<span class=\"w\">    </span><span class=\"nt\">privileged</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">false</span>\n</code></pre></div>\n<p>When I run the containers and Dataverse tries to access S3Â  an SdkClientException is thrown, describing that it could not find the region <br>\n<a href=\"/user_uploads/53090/O0ve2NzIovKs5d_VDzILxp2U/Screenshot-2024-05-28-at-16.34.22.png\">Screenshot-2024-05-28-at-16.34.22.png</a><br>\nHow can I specify the region?</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/O0ve2NzIovKs5d_VDzILxp2U/Screenshot-2024-05-28-at-16.34.22.png\" title=\"Screenshot-2024-05-28-at-16.34.22.png\"><img src=\"/user_uploads/53090/O0ve2NzIovKs5d_VDzILxp2U/Screenshot-2024-05-28-at-16.34.22.png\"></a></div>",
        "id": 441069419,
        "sender_full_name": "Guillermo Portas",
        "timestamp": 1716911762
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"598442\">@Guillermo Portas</span>. Please note that the storage subsystem has not yet been completely MPCONFIG enabled. The only options enabled to use MPCONFIG are the keys.</p>",
        "id": 443225156,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1717743740
    },
    {
        "content": "<p>It seems like the option to configure a \"real\" region is actually missing from the <a href=\"https://guides.dataverse.org/en/latest/installation/config.html#list-of-s3-storage-options\">S3 configuration options</a>!</p>",
        "id": 443225329,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1717743820
    },
    {
        "content": "<p>You can define a <code>custom-region</code> though. Let me check what's in the code for this and if you can use it to override things.</p>",
        "id": 443225504,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1717743886
    },
    {
        "content": "<p>Otherwise, the only other option to configure these regions I'm aware of would be a <code>~/.aws/config</code> entry</p>",
        "id": 443225596,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1717743941
    },
    {
        "content": "<p>Nope - the custom endpoint region thing is only available when using a custom endpoint URL</p>",
        "id": 443226018,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1717744101
    },
    {
        "content": "<p>You could try to define the official endpoint URL as custom URL <span aria-label=\"smile cat\" class=\"emoji emoji-1f638\" role=\"img\" title=\"smile cat\">:smile_cat:</span></p>",
        "id": 443226066,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1717744124
    },
    {
        "content": "<p>Yes, we talked about this on May 30th at a container meeting: <a href=\"https://harvard.zoom.us/rec/share/FVYyxSpMkOLX-jo9TLCBek0KhkZiFZ6e4v4Nka7M4eSpbVczSxrn5vLcKHG9if9x.cBqXOiQlyKpDN8pD\">https://harvard.zoom.us/rec/share/FVYyxSpMkOLX-jo9TLCBek0KhkZiFZ6e4v4Nka7M4eSpbVczSxrn5vLcKHG9if9x.cBqXOiQlyKpDN8pD</a></p>",
        "id": 443280318,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1717760654
    },
    {
        "content": "<p>As Oliver is saying, one has to use <code>custom-region</code> for now.</p>",
        "id": 443280383,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1717760678
    },
    {
        "content": "<p>Thank you <span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span>  and <span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> !</p>",
        "id": 443764504,
        "sender_full_name": "Guillermo Portas",
        "timestamp": 1718024051
    },
    {
        "content": "<p>I finally decided to use localstack for my testing setup, but I will take your comments into account for the future.</p>",
        "id": 443764757,
        "sender_full_name": "Guillermo Portas",
        "timestamp": 1718024140
    }
]