[
    {
        "content": "<p>As part of <a href=\"https://github.com/IQSS/dataverse/pull/9541\">https://github.com/IQSS/dataverse/pull/9541</a> I need to test S3.</p>\n<p>I've always tested S3 with Payara running directly on my Mac. <span aria-label=\"grimacing\" class=\"emoji emoji-1f62c\" role=\"img\" title=\"grimacing\">:grimacing:</span> </p>\n<p>It should be possible to supply all the necessary S3 config via MPCONFIG, right? That way I can continue my streak of doing all development with containers. <span aria-label=\"happy\" class=\"emoji emoji-1f600\" role=\"img\" title=\"happy\">:happy:</span> It's been over a month! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<p>I'd rather not switch back to Payara running directly on my Mac if I can avoid it!</p>",
        "id": 352814859,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682518597
    },
    {
        "content": "<p>Yes it is possible but only dirty, because the files part is not yet supporting MPCONFIG. So you need to use the \"dataverse_files_xxx_option=...\" env var hack. Mind the casing.</p>",
        "id": 352818600,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519311
    },
    {
        "content": "<p>Interesting. Do you have a list of env vars handy I can start with? If not, I'll look at the guides.</p>",
        "id": 352819215,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682519419
    },
    {
        "content": "<p>Just take the example from the startup script asa template <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 352819789,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519523
    },
    {
        "content": "<p>Sorry, which startup script?</p>",
        "id": 352820245,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682519623
    },
    {
        "content": "<p><a href=\"https://github.com/IQSS/dataverse/blob/4903e9f0277105ea6a8c59a2f962dac8bcf715f2/src/main/docker/scripts/init_2_configure.sh#L18-L22\">https://github.com/IQSS/dataverse/blob/4903e9f0277105ea6a8c59a2f962dac8bcf715f2/src/main/docker/scripts/init_2_configure.sh#L18-L22</a></p>",
        "id": 352820499,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519675
    },
    {
        "content": "<p>Nice. Thanks. I'll probably add some docs for this!</p>",
        "id": 352820776,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682519729
    },
    {
        "content": "<p>Sure. Don't put too much effort into it - should go away anyway with making the config of storage via MPCONFIG available. Someone needs to code that...</p>",
        "id": 352821013,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519778
    },
    {
        "content": "<p>Right. There's a comment about <a href=\"https://github.com/IQSS/dataverse/issues/7000\">https://github.com/IQSS/dataverse/issues/7000</a> but no PR yet, right?</p>",
        "id": 352821125,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682519801
    },
    {
        "content": "<p>Am I right that we don't plan to create a PR until milestone G? \"MPCONFIG for remaining dozen JVM settings (Size: 80)\"</p>",
        "id": 352821453,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682519875
    },
    {
        "content": "<p>No, that's not correct.</p>",
        "id": 352821616,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519899
    },
    {
        "content": "<p>Oh, wait. Milestone D. \"Configurability: Make storage configuration use MPCONFIG (Size: 33)\"</p>",
        "id": 352821651,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682519907
    },
    {
        "content": "<p>There are some config things in milestones along the way</p>",
        "id": 352821671,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519911
    },
    {
        "content": "<p>So all I have for now is a local branch and a stash of changes on my laptop for the work on the file storage thing</p>",
        "id": 352821808,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519938
    },
    {
        "content": "<p>Awesome. Want me to create an issue?</p>",
        "id": 352821922,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682519964
    },
    {
        "content": "<p>There was some discussion a while ago during some tech hour about  if it would be OK to require a list of storage names which IIRC was eventually put on hold with \"hmm yeah dunno maybe fine lets see\"</p>",
        "id": 352822075,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682519996
    },
    {
        "content": "<p>Well there is 7000, but maybe we can close that and create issues for the remaining parts</p>",
        "id": 352822239,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520019
    },
    {
        "content": "<p>Yeah, smaller chunks, I'm thinking.</p>",
        "id": 352822308,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682520036
    },
    {
        "content": "<p>(That would be mail, which has an issue, storage and \"the leftovers\")</p>",
        "id": 352822353,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520045
    },
    {
        "content": "<p>yum</p>",
        "id": 352822385,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682520053
    },
    {
        "content": "<p>I've been going on with this for a while... <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 352822707,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520109
    },
    {
        "content": "<p>Glad that it seems to be appreciated now among the devs... That lookup thing seems to be intriguing... <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 352823095,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520166
    },
    {
        "content": "<p>Well, now I need it. The ability to configure S3 in containers. <span aria-label=\"happy\" class=\"emoji emoji-1f600\" role=\"img\" title=\"happy\">:happy:</span></p>",
        "id": 352823462,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682520216
    },
    {
        "content": "<p>Hrhr... I remember we talked about this stuff long time ago and one of my arguments was \"you want this for containers\" <span aria-label=\"yum\" class=\"emoji emoji-1f60b\" role=\"img\" title=\"yum\">:yum:</span></p>",
        "id": 352823898,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520268
    },
    {
        "content": "<p>Ah BTW do you want to test localstack for S3?</p>",
        "id": 352824422,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520334
    },
    {
        "content": "<p>Or are you going to use Minio?</p>",
        "id": 352824505,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520341
    },
    {
        "content": "<p>(Or Seaweedfs)</p>",
        "id": 352824580,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520349
    },
    {
        "content": "<p>IIRC this is part of another milestone, would it make sense to take a look into how spin up the storage container, too?</p>",
        "id": 352824851,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520378
    },
    {
        "content": "<p>I'm going to use real S3. It's possible to configure it with the hacks above, right?</p>",
        "id": 352824876,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682520383
    },
    {
        "content": "<p>Yes, that's completely possible</p>",
        "id": 352825015,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520402
    },
    {
        "content": "<p>Oh wait: one thing... What I already had a chance to bring in for MPCONFIG and S3 is the keys thing</p>",
        "id": 352825277,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520426
    },
    {
        "content": "<p>So you don't need to think about how to deal with the AWS profile and config files in ~/.aws</p>",
        "id": 352825388,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520451
    },
    {
        "content": "<p>That is documented in the main section, it's been sitting there for a while and made <span class=\"user-mention\" data-user-id=\"598186\">@Don Sizemore</span> happy before</p>",
        "id": 352825559,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1682520472
    },
    {
        "content": "<p>I started editing my <code>.env</code> file today but got so confused I gave up and just ran Payara locally on my Mac. These are the (surely incorrect) values I was editing when I gave up:</p>\n<div class=\"codehilite\"><pre><span></span><code>DATAVERSE_FILES_STORAGE__DRIVER__ID=s3\nDATAVERSE_FILES_LOCAL_TYPE=s3\nDATAVERSE_FILES_LOCAL_LABEL=S3\nDATAVERSE.FILES.&lt;ID&gt;.ACCESS-KEY=\nDATAVERSE.FILES.&lt;ID&gt;.SECRET-KEY=\n</code></pre></div>\n<p>I'm happy to try again but I'd need some hand holding. Or more time (than I want to spend today) studying the code. Or I can just wait for MPCONFIG. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 354956708,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1682968028
    },
    {
        "content": "<p><span aria-label=\"leftwards hand\" class=\"emoji emoji-1faf2\" role=\"img\" title=\"leftwards hand\">:leftwards_hand:</span> Here you go</p>",
        "id": 355052201,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1683011791
    },
    {
        "content": "<p>May I point you towards <a href=\"http://preview.guides.gdcc.io/en/develop/container/app-image.html#tunables\">http://preview.guides.gdcc.io/en/develop/container/app-image.html#tunables</a> and the description of the \"dataverse_*\" vars? Maybe we should add a note that this is case sensitive.</p>",
        "id": 355052499,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1683011889
    },
    {
        "content": "<p>Ah, I didn't know about these magic trick rules.</p>",
        "id": 355112272,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1683025390
    },
    {
        "content": "<p>Replace - with __ for example.</p>",
        "id": 355112310,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1683025400
    },
    {
        "content": "<p>I wasn't sure what do with with SECRET-KEY and gave up.</p>",
        "id": 355112439,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1683025438
    },
    {
        "content": "<p>Both Secret and Access Key are already using MPCONFIG, so you may use either way</p>",
        "id": 355119237,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1683026954
    },
    {
        "content": "<p>Configuring S3 via MPCONFIG is possible, right? At least in containers?</p>",
        "id": 358967203,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684325664
    },
    {
        "content": "<p>No. Needs a hack.</p>",
        "id": 358967387,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1684325726
    },
    {
        "content": "<p>Ok, the but the hack should work. Great. I'll try again some day.</p>",
        "id": 358968275,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684325987
    },
    {
        "content": "<p>I was able to configure containerized Dataverse to use S3!</p>",
        "id": 359695401,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684509833
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>diff --git a/docker-compose-dev.yml b/docker-compose-dev.yml\nindex 30c55661a2..298a20b6ff 100644\n--- a/docker-compose-dev.yml\n+++ b/docker-compose-dev.yml\n@@ -13,6 +13,14 @@ services:\n       - DATAVERSE_DB_PASSWORD=secret\n       - DATAVERSE_DB_USER=${DATAVERSE_DB_USER}\n       - DATAVERSE_FEATURE_API_BEARER_AUTH=1\n+      - dataverse_files_storage__driver__id=s3\n+      - dataverse_files_s3_type=s3\n+      - dataverse_files_s3_label=S3\n+      - dataverse_files_s3_custom__endpoint__url=s3.us-east-2.amazonaws.com\n+      - dataverse_files_s3_custom__endpoint__region=us-east-2\n+      - dataverse_files_s3_bucket__name=pdurbin\n+      - dataverse_files_s3_access__key=REDACTED\n+      - dataverse_files_s3_secret__key=REDACTED\n     ports:\n       - &quot;8080:8080&quot; # HTTP (Dataverse Application)\n       - &quot;4848:4848&quot; # HTTP (Payara Admin Console)\n</code></pre></div>",
        "id": 359695555,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684509857
    },
    {
        "content": "<p>As you can see earlier in this thread, I was using UPPER CASE before, like any good sysadmin. But it seems like one must use lower case.</p>",
        "id": 359695805,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684509916
    },
    {
        "content": "<p>Yeah like I said (did I?) before in this thread, this is a limitation because we have a hack in place for now until the storage subsystem is MPCONFIGified</p>",
        "id": 359747781,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1684523383
    },
    {
        "content": "<p>Sorry 'bout that!</p>",
        "id": 359747797,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1684523389
    },
    {
        "content": "<p>Now I see you said \"case sensitive\" above.</p>",
        "id": 359752257,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684524851
    },
    {
        "content": "<p>And now I get it. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 359752305,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684524872
    },
    {
        "content": "<p>Sorry, I should have <strong>EMPHASIZED_IT_MORE</strong>. <span aria-label=\"yum\" class=\"emoji emoji-1f60b\" role=\"img\" title=\"yum\">:yum:</span></p>",
        "id": 359752367,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1684524902
    },
    {
        "content": "<p>Well, now I can document it: <a class=\"stream-topic\" data-stream-id=\"375812\" href=\"/#narrow/stream/375812-containers/topic/docs.20for.20milestone.20A.20.239540\">#containers &gt; docs for milestone A #9540</a></p>",
        "id": 359753201,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1684525152
    },
    {
        "content": "<p>I just thought I'd point out that this issue made it to the board. Currently it's in \"sprint ready\": Add S3 tests to the regular integration test suite <a href=\"https://github.com/IQSS/dataverse/issues/6783\">#6783</a></p>",
        "id": 384005327,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1691767084
    },
    {
        "content": "<p>Any discussion or prep for this S3 testing work? We could discuss it today or a future ct meeting if people want to.</p>",
        "id": 389629726,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1694084557
    },
    {
        "content": "<p>Before working on <a href=\"https://github.com/IQSS/dataverse/issues/6783\">#6783</a> should we merge <a href=\"https://github.com/IQSS/dataverse/issues/9273\">#9273</a> or does it not matter?</p>",
        "id": 391984598,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1695152921
    },
    {
        "content": "<p>Yes yes yes please merge first</p>",
        "id": 391985054,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1695153160
    },
    {
        "content": "<p>Oh I see it was added to the 6.1 milestone!</p>",
        "id": 391985100,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1695153181
    },
    {
        "content": "<p>Yes, both are flagged for 6.1.</p>",
        "id": 391985587,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1695153368
    },
    {
        "content": "<p>Great, thanks, I left a comment: <a href=\"https://github.com/IQSS/dataverse/issues/6783#issuecomment-1726389019\">https://github.com/IQSS/dataverse/issues/6783#issuecomment-1726389019</a></p>",
        "id": 391986010,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1695153560
    },
    {
        "content": "<p>Should I pick up this issue? Add S3 tests to the regular integration test suite <a href=\"https://github.com/IQSS/dataverse/issues/6783\">#6783</a></p>",
        "id": 394895047,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444004
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> are we in a better spot now that <a href=\"https://github.com/IQSS/dataverse/issues/9273\">#9273</a> has been merged? Do you have ideas on how to proceed with S3 testing?</p>",
        "id": 394895142,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444047
    },
    {
        "content": "<p>You bet we are!</p>",
        "id": 394895188,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444067
    },
    {
        "content": "<p>Do you want to work on this now?</p>",
        "id": 394895285,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444101
    },
    {
        "content": "<p>That's what I'm saying. It's in \"this sprint\". I could pick it up next.</p>",
        "id": 394895552,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444213
    },
    {
        "content": "<p>Oh! Wasn't aware!</p>",
        "id": 394895628,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444242
    },
    {
        "content": "<p>Want me to give you some thoughts and spill ideas?</p>",
        "id": 394895676,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444261
    },
    {
        "content": "<p>That's my job. To stare at the project board. <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 394895690,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444266
    },
    {
        "content": "<p>Yes, please hit me with ideas.</p>",
        "id": 394895717,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444279
    },
    {
        "content": "<p>The way I see it, we should definitely take a look at adding integration test using Testcontainers</p>",
        "id": 394895848,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444329
    },
    {
        "content": "<p>There are basically 2 ways to do this: go for LocalStack or use some other S3 compatible thing</p>",
        "id": 394895929,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444356
    },
    {
        "content": "<p><a href=\"https://java.testcontainers.org/modules/minio/\">https://java.testcontainers.org/modules/minio/</a></p>",
        "id": 394895992,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444382
    },
    {
        "content": "<p><a href=\"https://java.testcontainers.org/modules/localstack/\">https://java.testcontainers.org/modules/localstack/</a></p>",
        "id": 394896009,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444386
    },
    {
        "content": "<p>As we are using the official AWS Java SDK, it might be worth going for LocalStack</p>",
        "id": 394896176,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444446
    },
    {
        "content": "<p>No objection to LocalStack, though I've only heard of it.</p>",
        "id": 394896231,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444474
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> is a fan.</p>",
        "id": 394896249,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444483
    },
    {
        "content": "<p>You will have to do some ugly hacks with configuration... Sorry, but most <code>dataverse.files</code> S3 options ain't MPCONFIG enabled yet, so no nice simple wrapper with <code>@JvmSetting</code></p>",
        "id": 394896681,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444639
    },
    {
        "content": "<p>Oh, I know, I worked around them. I know the hacks.</p>",
        "id": 394896717,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444658
    },
    {
        "content": "<p>BeforeAll and AfterAll are your friends <span aria-label=\"smile cat\" class=\"emoji emoji-1f638\" role=\"img\" title=\"smile cat\">:smile_cat:</span></p>",
        "id": 394896778,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444676
    },
    {
        "content": "<p>So I need to add LocalStack to the docker compose file?</p>",
        "id": 394896880,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444700
    },
    {
        "content": "<p>No - Testcontainers makes containers start from within the test class</p>",
        "id": 394896928,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444726
    },
    {
        "content": "<p>No edit of the compose file necessary - it's much more self-contained this way</p>",
        "id": 394896987,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444750
    },
    {
        "content": "<p>Remember <a href=\"https://github.com/IQSS/dataverse/blob/develop/src/test/java/edu/harvard/iq/dataverse/authorization/providers/oauth2/oidc/OIDCAuthenticationProviderFactoryIT.java\">https://github.com/IQSS/dataverse/blob/develop/src/test/java/edu/harvard/iq/dataverse/authorization/providers/oauth2/oidc/OIDCAuthenticationProviderFactoryIT.java</a> ?</p>",
        "id": 394897067,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444792
    },
    {
        "content": "<p>It's basically the same thing</p>",
        "id": 394897175,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444817
    },
    {
        "content": "<p>There is a code example on the LocalStack TC docs page</p>",
        "id": 394897223,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444836
    },
    {
        "content": "<p>If you want, we can hack on this later</p>",
        "id": 394897250,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444844
    },
    {
        "content": "<p>(Meeting of DV Sustainability Group in 20)</p>",
        "id": 394897280,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696444858
    },
    {
        "content": "<p>Ok, so something like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>@Container\nstatic KeycloakContainer keycloakContainer = new KeycloakContainer(&quot;quay.io/keycloak/keycloak:22.0&quot;)\n</code></pre></div>",
        "id": 394897581,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696444970
    },
    {
        "content": "<p>Ok, I picked it up.</p>",
        "id": 394902661,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696447059
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> you might be interested in <a href=\"https://github.com/IQSS/dataverse/pull/9939/files#diff-7f214d6bbc0cb42b01ab03fb4b3d26fc18ca74c93e12ce998fbb7371f90f80ba\">https://github.com/IQSS/dataverse/pull/9939/files#diff-7f214d6bbc0cb42b01ab03fb4b3d26fc18ca74c93e12ce998fbb7371f90f80ba</a> and/or <a href=\"https://github.com/IQSS/dataverse/pull/9939/files#diff-cec3a75a2f2de0e5eed7be824f8305ec3101ec2a86d4ebc4e4939ce51e315997\">https://github.com/IQSS/dataverse/pull/9939/files#diff-cec3a75a2f2de0e5eed7be824f8305ec3101ec2a86d4ebc4e4939ce51e315997</a> for some more examples <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 395861401,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696937132
    },
    {
        "content": "<p>Would it be in scope to refactor the <code>dataverse.files.&lt;id&gt;</code> thing for this? It would make writing these tests much easier...</p>",
        "id": 395861525,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696937179
    },
    {
        "content": "<p>Thanks for the examples!</p>",
        "id": 395864853,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696938428
    },
    {
        "content": "<p>I don't know what to say about the refactoring. I'm buried in HR paperwork again and we have a visitor all week (which I'm looking forward to). I haven't been able to work on S3 testing at all. <span aria-label=\"disappointed\" class=\"emoji emoji-1f61e\" role=\"img\" title=\"disappointed\">:disappointed:</span></p>",
        "id": 395865051,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1696938490
    },
    {
        "content": "<p>It's your first day of the week, so no worries. And you did cleanse out loads of stuff over the weekend! So much dust came off!</p>",
        "id": 395866142,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696938861
    },
    {
        "content": "<p>In case it helps: there's also <a href=\"https://github.com/gaul/s3proxy\">https://github.com/gaul/s3proxy</a> which might be interesting for testing (transient memory storage), but might also add support to drop more storage backends and rely on a different component to create a bridge between Dataverse -&gt; S3 -&gt; sth else</p>",
        "id": 395871564,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696940673
    },
    {
        "content": "<p>If you are looking for sth. more lightweight not involving testcontainers, maybe <a href=\"https://github.com/findify/s3mock\">https://github.com/findify/s3mock</a> would be worth a look</p>",
        "id": 395872134,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1696940858
    },
    {
        "content": "<p><a href=\"https://github.com/IQSS/dataverse/issues/6783\">#6783</a> starts by talking about S3AccessIT, how we should add it to our Jenkins runs. But if we switch to S3 storage we won't be testing the filesystem anymore.</p>",
        "id": 396903562,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697463048
    },
    {
        "content": "<p>Can we test both?</p>",
        "id": 396903577,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697463055
    },
    {
        "content": "<p>Maybe. Should be doable.</p>",
        "id": 396922999,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697468544
    },
    {
        "content": "<p>Might need API extension though</p>",
        "id": 396923057,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697468559
    },
    {
        "content": "<p>But why only an e2e test?</p>",
        "id": 396923116,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697468580
    },
    {
        "content": "<p>No UT/IT?</p>",
        "id": 396923162,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697468593
    },
    {
        "content": "<p>Ha. Well, I thought I'd start with what we requested in the issue. I don't want to lose sight of that.</p>",
        "id": 396926238,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697469529
    },
    {
        "content": "<p>But yes, integration tests too, if I can figure it out.</p>",
        "id": 396926306,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697469549
    },
    {
        "content": "<p>But couldn't we just move that one test to a non e2e test?</p>",
        "id": 396927717,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697469959
    },
    {
        "content": "<p>(Haven't looked yet)</p>",
        "id": 396927819,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697469968
    },
    {
        "content": "<p>Wouldn't that safe the trouble of jumping through the E2E hoops with config and all?</p>",
        "id": 396928012,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697470016
    },
    {
        "content": "<p>Here's a handy link: <a href=\"https://github.com/IQSS/dataverse/blob/v6.0/src/test/java/edu/harvard/iq/dataverse/api/S3AccessIT.java\">https://github.com/IQSS/dataverse/blob/v6.0/src/test/java/edu/harvard/iq/dataverse/api/S3AccessIT.java</a></p>",
        "id": 396928060,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697470027
    },
    {
        "content": "<p>I'm not sure how to move it. Happy to talk about it.</p>",
        "id": 396928533,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697470155
    },
    {
        "content": "<p>To me this test looks like it's simply testing an upload and a deletion, making sure along the way the prefix is correct</p>",
        "id": 396958226,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697481976
    },
    {
        "content": "<p>IMHO there is no need to have a full fledged deployment around for that...</p>",
        "id": 396958278,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697482001
    },
    {
        "content": "<p>You saying that using Testcontainers we could create a dataset? Let me go look at the test you added.</p>",
        "id": 396965760,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697484637
    },
    {
        "content": "<p>OIDCAuthenticationProviderFactoryIT, that is</p>",
        "id": 396967068,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697485297
    },
    {
        "content": "<p>I could do a quiet, quick Zoom if it helps</p>",
        "id": 396967389,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697485473
    },
    {
        "content": "<p>Sure! <a href=\"https://harvard.zoom.us/j/98729082963?pwd=OUVmWnFwSTlibS9wOWI0aTRZOW45dz09\">https://harvard.zoom.us/j/98729082963?pwd=OUVmWnFwSTlibS9wOWI0aTRZOW45dz09</a></p>",
        "id": 396967597,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697485588
    },
    {
        "content": "<p>That was fun hacking! Thanks for doing all the typing <span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 396973613,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697488512
    },
    {
        "content": "<p>Ha! I'm the hands. You're the brain. It was fun!</p>",
        "id": 396973864,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697488651
    },
    {
        "content": "<p>I'm sending \"hello\" into S3AccessIO and pulling it out again,  making sure it's still \"hello\". Code coverage of that class has jumped from 0% to 7.88%!</p>",
        "id": 397164998,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697568501
    },
    {
        "content": "<p>Oh, wait. I'm not sure code coverage is being reported properly in Netbeans. <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 397178646,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697574889
    },
    {
        "content": "<p>For OIDCAuthProvider it's only showing 1.01%. I don't think that's right.</p>",
        "id": 397178883,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697575021
    },
    {
        "content": "<p>Ok, 67% when I look at <code>target/site/jacoco-integration-test-coverage-report/edu.harvard.iq.dataverse.authorization.providers.oauth2.oidc/OIDCAuthProvider.html</code>. Phew. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 397179085,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697575123
    },
    {
        "content": "<p>I wonder if there's a way to skip MOST tests except the one I'm working on. Something like this: <code>mvn verify -DskipTests=true -Dtest=S3AccessIOIT</code>.</p>",
        "id": 397183231,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697577400
    },
    {
        "content": "<p>Ok, actually, this seems to work: <code>mvn verify -Dtest=S3AccessIOIT</code></p>",
        "id": 397183610,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697577599
    },
    {
        "content": "<p>Hmm, I'm still seeing Keycloak output though, from the other test, I guess.</p>",
        "id": 397185912,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697578934
    },
    {
        "content": "<p><a href=\"https://maven.apache.org/surefire/maven-failsafe-plugin/integration-test-mojo.html#test\">https://maven.apache.org/surefire/maven-failsafe-plugin/integration-test-mojo.html#test</a></p>",
        "id": 397188711,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697580515
    },
    {
        "content": "<p>Thanks, I'll circle back to excluding Keycloak when testing S3 but right now I'm trying to configure multiple stores. I must be doing it wrong.</p>",
        "id": 397375499,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659047
    },
    {
        "content": "<p>This what I have:</p>\n<div class=\"codehilite\"><pre><span></span><code>- dataverse_files_storage__driver__id=file-1\n- dataverse_files_file-1_type=file\n- dataverse_files_file-1_label=Filesystem\n- dataverse_files_file-1_directory=${STORAGE_DIR}/store\n- dataverse_files_s3-3reals3_type=s3\n- dataverse_files_s3-3reals3_label=Real S3\n- dataverse_files_s3-3reals3_custom__endpoint__url=s3.us-east-2.amazonaws.com\n- dataverse_files_s3-3reals3_custom__endpoint__region=us-east-2\n- dataverse_files_s3-3reals3_bucket__name=pdurbin\n- dataverse_files_s3-3reals3_upload__redirect=true\n- dataverse_files_s3-3reals3_access__key=REDACTED\n- dataverse_files_s3-3reals3_secret__key=REDACTED\n</code></pre></div>",
        "id": 397375688,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659132
    },
    {
        "content": "<p>I'm trying to have a default \"file\" store called \"file-1\".</p>",
        "id": 397375728,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659155
    },
    {
        "content": "<p>And an \"s3\" store called \"s3-3reals3\".</p>",
        "id": 397375767,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659182
    },
    {
        "content": "<p>(I plan to add two more s3 stores: \"s3-1localstackdirect\" and \"s3-2localstackvanilla\" or something. Similar to what I wrote about at <a href=\"https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible/issues/327\">https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible/issues/327</a> )</p>",
        "id": 397376059,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659309
    },
    {
        "content": "<p>When I list the stores I only get the file-1 one:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;status&quot;: &quot;OK&quot;,\n    &quot;data&quot;: {\n        &quot;Filesystem&quot;: &quot;file-1&quot;\n    }\n}\n</code></pre></div>",
        "id": 397376148,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659341
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> do you see anything obvious I'm missing?</p>",
        "id": 397376234,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659384
    },
    {
        "content": "<p>I've only ever configured a single store in containerized Dataverse. I'm not sure if it's supported.</p>",
        "id": 397376686,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697659605
    },
    {
        "content": "<p>I am testing with two stores: one s3 and one file store. I use JVM_ARGS in my docker-compose like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>    environment:\n      JVM_ARGS:\n        -Ddataverse.timerServer=true\n        -Xmx24g\n        -Xms4g\n        -XX:+HeapDumpOnOutOfMemoryError\n        -XX:MaxMetaspaceSize=2g\n        -XX:MetaspaceSize=256m\n        -XX:+UseG1GC\n        -XX:+UseStringDeduplication\n        -XX:+DisableExplicitGC\n        -Ddataverse.files.s3.upload-out-of-band=true\n        -Ddataverse.api.allow-incomplete-metadata=true\n        -Ddataverse.ui.allow-review-for-incomplete=false\n        -Ddataverse.ui.show-validity-filter=true\n        -Ddataverse.files.directory=/data\n        -Ddataverse.files.uploads=/uploads\n        -Ddataverse.files.s3.type=s3\n        -Ddataverse.files.s3.label=s3\n        -Ddataverse.files.s3.bucket-name=dataverse-local\n        -Ddataverse.files.s3.download-redirect=true\n        -Ddataverse.files.s3.upload-redirect=true\n        -Ddataverse.files.s3.path-style-access=true\n        -Ddataverse.files.s3.custom-endpoint-url=https://rdmo.icts.kuleuven.be\n        -Ddataverse.files.s3.custom-endpoint-region=us-east-1\n        -Ddataverse.files.s3.disable-tagging=true\n        -Ddataverse.files.file.type=file\n        -Ddataverse.files.file.label=file\n        -Ddataverse.files.file.directory=/data\n</code></pre></div>\n<p>Notice the space on the end of each line (otherwise it will not work).<br>\nThis is the output from listing the storage:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n   &quot;status&quot;: &quot;OK&quot;,\n   &quot;data&quot;:    {\n      &quot;s3&quot;: &quot;s3&quot;,\n      &quot;file&quot;: &quot;file&quot;\n   }\n}\n</code></pre></div>",
        "id": 397454162,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697703441
    },
    {
        "content": "<p>It looks like Zulip strips the spaces, but there is space at the end of each line, before the end-of-line character, it functions as a separator for the jvm args.</p>",
        "id": 397455011,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697703736
    },
    {
        "content": "<p>I also mount the aws secrets and config like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>    volumes:\n      - /path/to/aws/config/.aws:/opt/payara/.aws\n      -...\n</code></pre></div>",
        "id": 397455710,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697704022
    },
    {
        "content": "<p>If you are interested, this is my entire image description:</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"w\">  </span><span class=\"nt\">dataverse</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nt\">image</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DATAVERSE_IMAGE_TAG}</span>\n<span class=\"w\">    </span><span class=\"nt\">hostname</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">dataverse</span>\n<span class=\"w\">    </span><span class=\"nt\">user</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">payara</span>\n<span class=\"w\">    </span><span class=\"nt\">networks</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">app_net</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">db_net</span>\n<span class=\"w\">    </span><span class=\"nt\">ports</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"s\">\"7005:4848\"</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"s\">\"7008:8080\"</span>\n<span class=\"w\">    </span><span class=\"nt\">environment</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"nt\">TZ</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"Europe/Brussels\"</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_DB_HOST</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">db</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_DB_PORT</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">5432</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_DB_USER</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DB_USER}</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_DB_NAME</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DB_NAME}</span>\n<span class=\"w\">      </span><span class=\"nt\">ENABLE_JDWP</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">0</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_MAIL_HOST</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${MAIL_SERVICE_HOST}</span>\n<span class=\"w\">      </span><span class=\"nt\">DATAVERSE_MAIL_FROM</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${MAIL_SENDER}</span>\n<span class=\"w\">      </span><span class=\"nt\">dataverse_fqdn</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${FQDN}</span>\n<span class=\"w\">      </span><span class=\"nt\">dataverse_siteUrl</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DATAVERSE_URL}</span>\n<span class=\"w\">      </span><span class=\"nt\">dataverse_files_storage__driver__id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DRIVER_ID}</span>\n<span class=\"w\">      </span><span class=\"nt\">db_SystemEmail</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${MAIL_SENDER_NAME}</span>\n<span class=\"w\">      </span><span class=\"nt\">CUSTOM_INSTALL</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"/opt/payara/custominstall\"</span>\n<span class=\"w\">      </span><span class=\"nt\">API_DEBUG</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"false\"</span>\n<span class=\"w\">      </span><span class=\"nt\">LANG_DIR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"/languages\"</span>\n<span class=\"w\">      </span><span class=\"nt\">STORAGE_DIR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"/data\"</span>\n<span class=\"w\">      </span><span class=\"nt\">SECRETS_DIR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"/run/secrets\"</span>\n<span class=\"w\">      </span><span class=\"nt\">DUMPS_DIR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"/dumps\"</span>\n<span class=\"w\">      </span><span class=\"nt\">UPLOAD_DIR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"/uploads\"</span>\n<span class=\"w\">      </span><span class=\"nt\">MP_CONFIG_PROFILE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${RDM_STAGE}</span>\n<span class=\"w\">      </span><span class=\"nt\">JVM_ARGS</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.timerServer=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Xmx24g</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Xms4g</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-XX:+HeapDumpOnOutOfMemoryError</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-XX:MaxMetaspaceSize=2g</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-XX:MetaspaceSize=256m</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-XX:+UseG1GC</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-XX:+UseStringDeduplication</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-XX:+DisableExplicitGC</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.upload-out-of-band=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.api.allow-incomplete-metadata=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.ui.allow-review-for-incomplete=false</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.ui.show-validity-filter=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.directory=/data</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.uploads=/uploads</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.type=s3</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.label=s3</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.bucket-name=dataverse-local</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.download-redirect=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.upload-redirect=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.path-style-access=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.custom-endpoint-url=https://rdmo.icts.kuleuven.be</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.custom-endpoint-region=us-east-1</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.s3.disable-tagging=true</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.file.type=file</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.file.label=file</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.files.file.directory=/data</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.solr.host=solr</span>\n<span class=\"w\">        </span><span class=\"l l-Scalar l-Scalar-Plain\">-Ddataverse.mail.cc-support-on-contact-email=rdr@kuleuven.be</span>\n<span class=\"w\">    </span><span class=\"nt\">volumes</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">/etc/localtime:/etc/localtime:ro</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">./config/dataverse:/opt/payara/custominstall</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">./config/dataverse/set_language.sh:/opt/payara/scripts/init.d/set_language.sh</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">./config/dataverse/change-admin-password.sh:/opt/payara/scripts/init.d/change-admin-password.sh</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DV_FILES}:/data</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DV_DUMPS}:/dumps</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DV_UPLOADS}:/uploads</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DV_LANG_DIR}:/languages</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DOCROOT}:/opt/payara/appserver/glassfish/domains/domain1/docroot</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${SECRETS}:/run/secrets</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${SECRETS}/microprofile:/secrets</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">${DV_PATH}/aws:/opt/payara/.aws</span>\n<span class=\"w\">    </span><span class=\"nt\">depends_on</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">proxy</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">db</span>\n<span class=\"w\">      </span><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">index</span>\n<span class=\"w\">    </span><span class=\"nt\">restart</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">unless-stopped</span>\n<span class=\"w\">    </span><span class=\"nt\">privileged</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">false</span>\n</code></pre></div>\n<p>I use a standard image built with maven. I think that the interesting script is the one that changes the admin password (you see it mounted in volumes):</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"ch\">#!/usr/bin/env bash</span>\n\n<span class=\"c1\"># Check and load secrets</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"w\"> </span>!<span class=\"w\"> </span>-s<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"si\">${</span><span class=\"nv\">SECRETS_DIR</span><span class=\"si\">}</span><span class=\"s2\">/admin/password\"</span><span class=\"w\"> </span><span class=\"o\">]</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">  </span><span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"No admin password present. Failing.\"</span>\n<span class=\"w\">  </span><span class=\"nb\">exit</span><span class=\"w\"> </span><span class=\"m\">126</span>\n<span class=\"k\">fi</span>\n<span class=\"nv\">ADMIN_PASSWORD</span><span class=\"o\">=</span><span class=\"k\">$(</span>cat<span class=\"w\"> </span><span class=\"s2\">\"</span><span class=\"si\">${</span><span class=\"nv\">SECRETS_DIR</span><span class=\"si\">}</span><span class=\"s2\">/admin/password\"</span><span class=\"k\">)</span>\n\n<span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"AS_ADMIN_PASSWORD=admin\"</span><span class=\"w\"> </span>&gt;<span class=\"w\"> </span>/tmp/password-change-file.txt\n<span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"AS_ADMIN_NEWPASSWORD=</span><span class=\"si\">${</span><span class=\"nv\">ADMIN_PASSWORD</span><span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"w\"> </span>&gt;&gt;<span class=\"w\"> </span>/tmp/password-change-file.txt\n<span class=\"nb\">echo</span><span class=\"w\"> </span><span class=\"s2\">\"AS_ADMIN_PASSWORD=</span><span class=\"si\">${</span><span class=\"nv\">ADMIN_PASSWORD</span><span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"w\"> </span>&gt;&gt;<span class=\"w\"> </span><span class=\"si\">${</span><span class=\"nv\">PASSWORD_FILE</span><span class=\"si\">}</span>\nasadmin<span class=\"w\"> </span>--user<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">ADMIN_USER</span><span class=\"si\">}</span><span class=\"w\"> </span>--passwordfile<span class=\"o\">=</span>/tmp/password-change-file.txt<span class=\"w\"> </span>change-admin-password<span class=\"w\"> </span>--domain_name<span class=\"o\">=</span><span class=\"si\">${</span><span class=\"nv\">DOMAIN_NAME</span><span class=\"si\">}</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"nb\">true</span>\nrm<span class=\"w\"> </span>/tmp/password-change-file.txt\n</code></pre></div>",
        "id": 397459865,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697705505
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614964\">@Eryk Kulikowski</span> that actually works?!? JVM_ARGS?!? <span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> have you seen this?</p>",
        "id": 397481973,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697713701
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614964\">@Eryk Kulikowski</span> what is the value of ${DATAVERSE_IMAGE_TAG} please?</p>",
        "id": 397482050,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697713736
    },
    {
        "content": "<p>It works, you can pass any JVM/microprofile settings like this, just remember to add a space ( \" \") after each argument. Otherwise, it will be sticking together. You can check if it worked in your server log when using it:</p>\n<div class=\"codehilite\"><pre><span></span><code>[Entrypoint] running /opt/payara/scripts/startInForeground.sh in foreground\nExecuting Payara Server with the following command line:\n/opt/java/openjdk/bin/java\n-cp\n/opt/payara/appserver/glassfish/domains/domain1/lib/ext/*:/opt/payara/appserver/glassfish/modules/glassfish.jar\n-Ddataverse.timerServer=true\n-Xmx24g\n-Xms4g\n-XX:+HeapDumpOnOutOfMemoryError\n-XX:MaxMetaspaceSize=2g\n-XX:MetaspaceSize=256m\n-XX:+UseG1GC\n-XX:+UseStringDeduplication\n-XX:+DisableExplicitGC\n-Ddataverse.files.s3.upload-out-of-band=true\n-Ddataverse.api.allow-incomplete-metadata=true\n-Ddataverse.ui.allow-review-for-incomplete=false\n-Ddataverse.ui.show-validity-filter=true\n-Ddataverse.files.directory=/data\n-Ddataverse.files.uploads=/uploads\n-Ddataverse.files.s3.type=s3\n-Ddataverse.files.s3.label=s3\n-Ddataverse.files.s3.bucket-name=dataverse-local\n-Ddataverse.files.s3.download-redirect=true\n-Ddataverse.files.s3.upload-redirect=true\n-Ddataverse.files.s3.path-style-access=true\n-Ddataverse.files.s3.custom-endpoint-url=https://rdmo.icts.kuleuven.be\n-Ddataverse.files.s3.custom-endpoint-region=us-east-1\n-Ddataverse.files.s3.disable-tagging=true\n-Ddataverse.files.file.type=file\n-Ddataverse.files.file.label=file\n-Ddataverse.files.file.directory=/data\n-Ddataverse.solr.host=solr\n-Ddataverse.mail.cc-support-on-contact-email=rdr@kuleuven.be\n-Ddataverse.lang.directory=/languages\n\n-XX:+UnlockDiagnosticVMOptions\n...\n-Dfelix.fileinstall.bundles.startTransient=true\n\n-Dcom.sun.enterprise.config.config_environment_factory_class=com.sun.enterprise.config.serverbeans.AppserverConfigEnvironmentFactory\n...\n-Djava.library.path=/opt/payara/appserver/glassfish/lib:/usr/java/packages/lib:/usr/lib64:/lib64:/lib:/usr/lib\ncom.sun.enterprise.glassfish.bootstrap.ASMain\n/opt/payara/config/pre-boot-commands.asadmin\n-upgrade\nfalse\n-read-stdin\ntrue\n-postbootcommandfile\n/opt/payara/config/post-boot-commands.asadmin\n-domainname\ndomain1\n-domaindir\n/opt/payara/appserver/glassfish/domains/domain1\n-asadmin-args\n--host,,,localhost,,,--port,,,4848,,,--user,,,admin,,,--passwordfile,,,/opt/payara/passwordFile,,,--secure=false,,,--terse=false,,,--extraterse=false,,,--echo=false,,,--interactive=false,,,--autoname=false,,,start-domain,,,--verbose=false,,,--watchdog=false,,,--debug=false,,,--domaindir,,,/opt/payara/appserver/glassfish/domains,,,domain1\n-instancename\nserver\n-type\nDAS\n-verbose\nfalse\n-asadmin-classpath\n/opt/payara/appserver/glassfish/lib/client/appserver-cli.jar\n-debug\nfalse\n-asadmin-classname\ncom.sun.enterprise.admin.cli.AdminMain\n-watchdog\nfalse\n\nLaunching Payara Server on Felix platform\nOct 18, 2023 2:02:14 PM com.sun.enterprise.glassfish.bootstrap.osgi.BundleProvisioner createBundleProvisioner\nINFO: Create bundle provisioner class = class com.sun.enterprise.glassfish.bootstrap.osgi.BundleProvisioner.\nRegistered com.sun.enterprise.glassfish.bootstrap.osgi.EmbeddedOSGiGlassFishRuntime@7c581736 in service registry.\nReading in commandments from /opt/payara/config/pre-boot-commands.asadmin\n</code></pre></div>",
        "id": 397492051,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697717447
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> <br>\nWe use our own LIBIS registry for docker images. We build them with rdm-build <a href=\"https://github.com/libis/rdm-build\">https://github.com/libis/rdm-build</a><br>\nCheck this script <a href=\"https://github.com/libis/rdm-build/blob/main/images/dataverse/build_dv.sh\">https://github.com/libis/rdm-build/blob/main/images/dataverse/build_dv.sh</a><br>\nIt uses env variables from here: <a href=\"https://github.com/libis/rdm-build/blob/main/env.dev\">https://github.com/libis/rdm-build/blob/main/env.dev</a><br>\nResulting image tag is: <a href=\"http://docker.io/rdm/dataverse-stock:1.5\">docker.io/rdm/dataverse-stock:1.5</a><br>\nI add ruby to that in <a href=\"https://github.com/libis/rdm-build/blob/main/images/dataverse/Dockerfile\">https://github.com/libis/rdm-build/blob/main/images/dataverse/Dockerfile</a><br>\nThe final image tag is <a href=\"http://docker.io/rdm/dataverse:1.5\">docker.io/rdm/dataverse:1.5</a><br>\nWhere <a href=\"http://docker.io\">docker.io</a> becomes our own LIBIS registry when building for production (STAGE=prod).<br>\nThis particular image is still in test, not yet in pilot or production.</p>",
        "id": 397493097,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697717831
    },
    {
        "content": "<p>My specific branch build script: <a href=\"https://github.com/libis/rdm-build/blob/main/images/dataverse/build_dev_dv.sh\">https://github.com/libis/rdm-build/blob/main/images/dataverse/build_dev_dv.sh</a><br>\nThe other one uses the tagged version it checks out (notice that you download specific maven and java in the script, but it uses your default maven registry): <a href=\"https://github.com/libis/rdm-build/blob/main/images/dataverse/build_dv.sh\">https://github.com/libis/rdm-build/blob/main/images/dataverse/build_dv.sh</a></p>",
        "id": 397493725,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697718063
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614964\">@Eryk Kulikowski</span> what are you doing in an hour? Would you like to join the Containerization Working Group meeting? <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> <a href=\"https://ct.gdcc.io\">https://ct.gdcc.io</a></p>",
        "id": 397495116,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697718542
    },
    {
        "content": "<p>As a compose file is YAML, you might try using <code>JVM_ARG: &gt;</code>. See also <a href=\"https://yaml.org/spec/1.2.2/#line-folding\">https://yaml.org/spec/1.2.2/#line-folding</a></p>",
        "id": 397495763,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697718776
    },
    {
        "content": "<p>(So you should not need to pay attention about the spaces at the end)</p>",
        "id": 397495814,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697718796
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"614964\">@Eryk Kulikowski</span> I'm glad to see you are basing your work on the WG outputs! Glad it's being reused. Looks like we made it customizable enough.</p>",
        "id": 397496710,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697719134
    },
    {
        "content": "<p>FWIW <span class=\"user-mention\" data-user-id=\"614964\">@Eryk Kulikowski</span>, using <code>Xmx</code>, <code>Xms</code> etc in a container context is not considered good practice. Did you see the env vars for memory management in the tunables table? <a href=\"http://preview.guides.gdcc.io/en/develop/container/base-image.html#tunables\">http://preview.guides.gdcc.io/en/develop/container/base-image.html#tunables</a> You can easily asign the 24g of RAM defining the container limits in the compose definition, by default 70% of that will be allocated as heap.</p>",
        "id": 397497051,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697719264
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span>  Thanks! I will check it out!</p>",
        "id": 397498836,
        "sender_full_name": "Eryk Kulikowski",
        "timestamp": 1697719849
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> where I'm at: I have the basics in place, but next to read in both buckets' settings and tell Ansible to provision them within the container: <a href=\"https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible/blob/327_multiple_s3_stores/tests/group_vars/jenkins.yml#L336\">https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible/blob/327_multiple_s3_stores/tests/group_vars/jenkins.yml#L336</a><br>\nOne of my questions was whether you want want the S3 testing to provision said LocalStack buckets, but that would break testing on S3 proper. Any further direction/thoughts from you and/or <span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> at this point most welcome.</p>",
        "id": 397523399,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1697727363
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> hmm, would it be a permanent break on testing S3 proper? Or more that if we someday want to test both S3 and LocalStack that we'd need to do further refactoring on the Ansible side?</p>",
        "id": 397537544,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697731922
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598843\">@Deirdre Kirmis</span> if your ears were burning a couple hours ago, we were trying to remember what flavor of S3 you use. Something on Dell, I think.</p>",
        "id": 397537690,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697731971
    },
    {
        "content": "<p>we use aws s3 .. we tried for about a year to use Dell Isilon S3 for one of our stores but never got it working =)</p>",
        "id": 397539785,
        "sender_full_name": "Deirdre Kirmis",
        "timestamp": 1697732811
    },
    {
        "content": "<p>Oh. Bummer!</p>",
        "id": 397539859,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697732853
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598843\">Deirdre Kirmis</span> <a href=\"#narrow/stream/375812-containers/topic/testing.20S3/near/397539785\">said</a>:</p>\n<blockquote>\n<p>we use aws s3 .. we tried for about a year to use Dell Isilon S3 for one of our stores but never got it working =)</p>\n</blockquote>\n<p>Have you ever tried to front the Isilon with Minio? I will probably do sth like that with our internal S3 to enable direct up/download. <a href=\"https://min.io/docs/minio/linux/administration/object-management/transition-objects-to-s3.html\">https://min.io/docs/minio/linux/administration/object-management/transition-objects-to-s3.html</a></p>",
        "id": 397539911,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697732880
    },
    {
        "content": "<p>i think there is actually a fix to dataverse now (it was a bug in apache on the isilon server) .. but we decided to go all in on aws</p>",
        "id": 397539964,
        "sender_full_name": "Deirdre Kirmis",
        "timestamp": 1697732887
    },
    {
        "content": "<p>i did try fronting it with  minio .. i need to look back at my notes to see how that went .. i think i ran into some problems there too</p>",
        "id": 397540026,
        "sender_full_name": "Deirdre Kirmis",
        "timestamp": 1697732931
    },
    {
        "content": "<p>but i also don't exactly always know what i'm doing <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 397540047,
        "sender_full_name": "Deirdre Kirmis",
        "timestamp": 1697732948
    },
    {
        "content": "<p>Welcome to the club, here's your  member id <span aria-label=\"identification card\" class=\"emoji emoji-1faaa\" role=\"img\" title=\"identification card\">:identification_card:</span> <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span></p>",
        "id": 397540200,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697733007
    },
    {
        "content": "<p><span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> always fun to test things out!</p>",
        "id": 397540252,
        "sender_full_name": "Deirdre Kirmis",
        "timestamp": 1697733037
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> Ansible can create and configure the buckets in LocalStack, but if for some/any reason Dataverse wanted to, it could? I don't think you want this to be the case, but just checking.</p>",
        "id": 397545238,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1697735192
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> I think I'm a little slow today but I think we're on the same page. All good. <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 397552233,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697738237
    },
    {
        "content": "<p>After today's meeting I was all excited to try the magic trick with store names that don't have dashes in them.</p>",
        "id": 397562559,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697742560
    },
    {
        "content": "<p>I tried this:</p>\n<div class=\"codehilite\"><pre><span></span><code>- dataverse_files_storage__driver__id=file1\n- dataverse_files_file1_type=file\n- dataverse_files_file1_label=Filesystem\n- dataverse_files_file1_directory=${STORAGE_DIR}/store\n- dataverse_files_s3c_type=s3\n- dataverse_files_s3c_label=Real S3\n- dataverse_files_s3c_custom__endpoint__url=s3.us-east-2.amazonaws.com\n- dataverse_files_s3c_custom__endpoint__region=us-east-2\n- dataverse_files_s3c_bucket__name=pdurbin\n- dataverse_files_s3c_upload__redirect=true\n- dataverse_files_s3c_access__key=REDACTED\n- dataverse_files_s3c_secret__key=REDACTED\n</code></pre></div>",
        "id": 397562573,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697742569
    },
    {
        "content": "<p>However, when I list the stores, I still only see the one:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;status&quot;: &quot;OK&quot;,\n    &quot;data&quot;: {\n        &quot;Filesystem&quot;: &quot;file1&quot;\n    }\n}\n</code></pre></div>",
        "id": 397562645,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697742603
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> ^^</p>",
        "id": 397562684,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697742608
    },
    {
        "content": "<p>I guess I'll try JVM_ARGS next.</p>",
        "id": 397562723,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697742629
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>[ERROR] Failed to execute goal io.fabric8:docker-maven-plugin:0.43.4:run (default-cli) on project dataverse: Execution default-cli of goal io.fabric8:docker-maven-plugin:0.43.4:run failed: while scanning a simple key\n[ERROR]  in &#39;reader&#39;, line 23, column 9:\n[ERROR]             -Ddataverse.files.storage-driver ...\n[ERROR]             ^\n[ERROR] could not find expected &#39;:&#39;\n[ERROR]  in &#39;reader&#39;, line 24, column 9:\n[ERROR]             -Ddataverse.files.file1.type=file\n[ERROR]             ^\n</code></pre></div>",
        "id": 397566321,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697744296
    },
    {
        "content": "<p>... when using this file:</p>\n<p><a href=\"/user_uploads/53090/4VMU3UaDhBQBKTJyWwZUCGfh/docker-compose-dev.yml\">docker-compose-dev.yml</a></p>",
        "id": 397566426,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697744358
    },
    {
        "content": "<p>From <a href=\"https://www.yamllint.com\">https://www.yamllint.com</a></p>\n<p><a href=\"/user_uploads/53090/LV9J05dED8upjX05z2crma6h/Screenshot-2023-10-19-at-4.25.49-PM.png\">Screenshot-2023-10-19-at-4.25.49-PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/LV9J05dED8upjX05z2crma6h/Screenshot-2023-10-19-at-4.25.49-PM.png\" title=\"Screenshot-2023-10-19-at-4.25.49-PM.png\"><img src=\"/user_uploads/53090/LV9J05dED8upjX05z2crma6h/Screenshot-2023-10-19-at-4.25.49-PM.png\"></a></div>",
        "id": 397572543,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697747171
    },
    {
        "content": "<p>Ah ha! I think (I hope) I got it.</p>",
        "id": 397573417,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697747609
    },
    {
        "content": "<p>Nope. <span aria-label=\"very angry\" class=\"emoji emoji-1f621\" role=\"img\" title=\"very angry\">:very_angry:</span></p>",
        "id": 397573660,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697747741
    },
    {
        "content": "<p>Weird! I sort of got it working?!? But I have three stores when I expected two:</p>\n<div class=\"codehilite\"><pre><span></span><code>{\n    &quot;status&quot;: &quot;OK&quot;,\n    &quot;data&quot;: {\n        &quot;RealS3&quot;: &quot;s3c&quot;,\n        &quot;Local&quot;: &quot;local&quot;,\n        &quot;Filesystem&quot;: &quot;file1&quot;\n    }\n}\n</code></pre></div>",
        "id": 397576752,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697749204
    },
    {
        "content": "<p>Here's my file:</p>\n<p><a href=\"/user_uploads/53090/VbH856MoKh8j12oW4tuTcQdZ/docker-compose-dev.yml\">docker-compose-dev.yml</a></p>",
        "id": 397576845,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697749236
    },
    {
        "content": "<p>file1 and s3c I expect. I'm not sure where local is coming from. <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 397577432,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697749560
    },
    {
        "content": "<p>Just capturing some commands and output that <span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> helped me figure out to prove to myself that we can upload a test file from the Dataverse/Payara container to the Localstack container:</p>\n<div class=\"codehilite\"><pre><span></span><code>payara@dataverse:~$ echo -e &#39;[default]\\nregion = us-east-2&#39; &gt; ~/.aws/config\npayara@dataverse:~$ cat ~/.aws/config\n[default]\nregion = us-east-2\npayara@dataverse:~$ echo -e &#39;[default]\\naws_access_key_id = default\\naws_secret_access_key = default&#39; &gt; ~/.aws/credentials\npayara@dataverse:~$ cat ~/.aws/credentials\n[default]\naws_access_key_id = default\naws_secret_access_key = default\npayara@dataverse:~$\npayara@dataverse:~$ aws --endpoint-url=http://localstack:4566 s3 ls\n2023-10-23 18:02:38 mybucket\npayara@dataverse:~$\npayara@dataverse:~$ echo foo &gt; test.txt\npayara@dataverse:~$ cat test.txt\nfoo\npayara@dataverse:~$ aws --endpoint-url=http://localstack:4566 s3 cp test.txt s3://mybucket/\nupload: ./test.txt to s3://mybucket/test.txt\npayara@dataverse:~$ aws --endpoint-url=http://localstack:4566 s3 ls s3://mybucket/\n2023-10-23 18:13:23          4 test.txt\npayara@dataverse:~$\n</code></pre></div>",
        "id": 398148321,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698091481
    },
    {
        "content": "<p>But we still can't upload files from Dataverse itself to LocalStack. Here's the config I'm using:</p>\n<div class=\"codehilite\"><pre><span></span><code>-Ddataverse.files.localstack1.type=s3\n-Ddataverse.files.localstack1.label=LocalStack\n-Ddataverse.files.localstack1.custom-endpoint-url=http://localstack:4566\n-Ddataverse.files.localstack1.custom-endpoint-region=us-east-2\n-Ddataverse.files.localstack1.bucket-name=mybucket\n-Ddataverse.files.localstack1.upload-redirect=false\n-Ddataverse.files.localstack1.access-key=default\n-Ddataverse.files.localstack1.secret-key=default\n</code></pre></div>",
        "id": 398148467,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698091574
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598183\">@Oliver Bertuch</span> any ideas for me? I think I might try MinIO instead.</p>",
        "id": 398148493,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698091597
    },
    {
        "content": "<p>Ah ha! For Minio, at least, I needed this:</p>\n<div class=\"codehilite\"><pre><span></span><code>-Ddataverse.files.minio1.path-style-access=true\n</code></pre></div>",
        "id": 398157872,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698096018
    },
    {
        "content": "<p>As mentioned in our docs: <a href=\"https://guides.dataverse.org/en/6.0/installation/config.html#reported-working-s3-compatible-storage\">https://guides.dataverse.org/en/6.0/installation/config.html#reported-working-s3-compatible-storage</a></p>",
        "id": 398157893,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698096030
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> please remind me, do you have a preference for LocalStack or MinIO? I'm certainly happy to see if the trick above works with LocalStack.</p>",
        "id": 398340496,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698172100
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598112\">Philip Durbin</span> <a href=\"#narrow/stream/375812-containers/topic/testing.20S3/near/398340496\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"626369\">Don Sizemore</span> please remind me, do you have a preference for LocalStack or MinIO? I'm certainly happy to see if the trick above works with LocalStack.</p>\n</blockquote>\n<p>I really don't. LocalStack sounds better for testing overall; MinIO sounds better for sites like ASU who use Dell MinIO. Also because I have to keep correcting myself when I type Minion.</p>",
        "id": 398344636,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1698173947
    },
    {
        "content": "<p>Well, the <code>path-style-access=true</code> trick does seem to work for LocalStack.</p>",
        "id": 398345250,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698174196
    },
    {
        "content": "<p>I'm testing both.</p>",
        "id": 398361854,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698182187
    },
    {
        "content": "<p>LocalStack is finickier about bucket creation. I've only had luck creating the bucket with <code>awslocal s3 mb s3://mybucket</code> (rather than Java).</p>",
        "id": 398493181,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698242785
    },
    {
        "content": "<p>I made a draft pull request! add S3 tests, LocalStack, MinIO <a href=\"https://github.com/IQSS/dataverse/issues/6783\">#6783</a> <a href=\"https://github.com/IQSS/dataverse/issues/10044\">#10044</a></p>",
        "id": 398509024,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698247085
    },
    {
        "content": "<p>Feedback very welcome, of course!</p>",
        "id": 398509905,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698247308
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin</span> sorry a bit late, as you have figured it out with the S3 properties. </p>\n<p>I have used the following way to specify the properties (just as environment variables on the container):</p>\n<div class=\"codehilite\"><pre><span></span><code>  dataverse:\n    image: gdcc/dataverse:unstable\n    container_name: dataverse\n    hostname: dataverse\n    user: payara\n    labels:\n      com.platys.name: dataverse\n      com.platys.webui.title: Dataverse UI\n      com.platys.webui.url: http://dataplatform:28294\n      com.platys.restapi.title: Dataverse UI\n      com.platys.restapi.url: http://dataplatform:28294/api/info/metrics/dataverses\n    ports:\n      - 28294:8080\n      - 4848:4848\n      - 9009:9009   # JDWP\n      - 8686:8686   # JMX\n    environment:\n      - DATAVERSE_FQDN=${PUBLIC_IP}\n      - _CT_DATAVERSE_SITEURL=http://${PUBLIC_IP}:28294\n      - DATAVERSE_DB_HOST=dataverse-postgresql\n      - DATAVERSE_DB_USER=dataverse\n      - DATAVERSE_DB_PASSWORD=abc123!\n      - DATAVERSE_MAIL_HOST=mailpit\n      - DATAVERSE_MAIL_FROM=dataverse@localhost\n      - _CT_DATAVERSE_SOLR_HOST=dataverse-solr\n      - DATAVERSE_SOLR_PORT=8983\n      - ENABLE_JMX=0\n      - ENABLE_RELOAD=0\n      - ENABLE_JDWP=1\n      - dataverse_files_s3_type=s3\n      - dataverse_files_s3_label=&quot;Object Storage&quot;\n      - dataverse_files_s3_bucket__name=&quot;dataverse-bucket&quot;\n      - dataverse_files_s3_custom__endpoint__url=http://${EADP_IP}:9000\n      - dataverse_files_s3_custom__endpoint__region=&#39;us-east-1&#39;\n      - dataverse_files_s3_path__style__access=True\n      - dataverse_files_s3_access__key=${PLATYS_AWS_ACCESS_KEY:?PLATYS_AWS_ACCESS_KEY must be set either in .env or as an environment variable}\n      - dataverse_files_s3_secret__key=${PLATYS_AWS_SECRET_ACCESS_KEY:?PLATYS_AWS_SECRET_ACCESS_KEY must be set either in .env or as an environment variable}\n</code></pre></div>",
        "id": 398852639,
        "sender_full_name": "Guido Schmutz",
        "timestamp": 1698396114
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"656972\">@Guido Schmutz</span> right, I'm able to configure a single file store like that, with environment variables, but when I tried to configure multiple stores, it didn't work. If you get a chance to try this, please let me know! Otherwise, I'll wait for a fix for <a href=\"https://github.com/IQSS/dataverse/issues/9998\">#9998</a>.</p>",
        "id": 398880097,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698406320
    },
    {
        "content": "<p>ok, I see, you configure multiple stores, challenge accepted ;-)  ... took me a while to figure it out, but now it works </p>\n<div class=\"codehilite\"><pre><span></span><code>  dataverse:\n    image: gdcc/dataverse:unstable\n    container_name: dataverse\n    hostname: dataverse\n    user: payara\n    labels:\n      com.platys.name: dataverse\n      com.platys.webui.title: Dataverse UI\n      com.platys.webui.url: http://dataplatform:28294\n      com.platys.restapi.title: Dataverse UI\n      com.platys.restapi.url: http://dataplatform:28294/api/info/metrics/dataverses\n    ports:\n      - 28294:8080\n      - 4848:4848\n      - 9009:9009   # JDWP\n      - 8686:8686   # JMX\n    environment:\n      - DATAVERSE_FQDN=${PUBLIC_IP}\n      - _CT_DATAVERSE_SITEURL=http://${PUBLIC_IP}:28294\n      - DATAVERSE_DB_HOST=dataverse-postgresql\n      - DATAVERSE_DB_USER=dataverse\n      - DATAVERSE_DB_PASSWORD=abc123!\n      - DATAVERSE_MAIL_HOST=mailpit\n      - DATAVERSE_MAIL_FROM=dataverse@localhost\n      - _CT_DATAVERSE_SOLR_HOST=dataverse-solr\n      - DATAVERSE_SOLR_PORT=8983\n      - ENABLE_JMX=0\n      - ENABLE_RELOAD=0\n      - ENABLE_JDWP=1\n      - dataverse_files_storage__driver__id=s3\n      - dataverse_files_file1_type=file\n      - dataverse_files_file1_label=&quot;Local Filesystem&quot;\n      - dataverse_files_file1_directory=${STORAGE_DIR}/store\n      - dataverse_files_s3_type=s3\n      - dataverse_files_s3_label=&quot;Object Storage&quot;\n      - dataverse_files_s3_bucket__name=&quot;dataverse-bucket&quot;\n      - dataverse_files_s3_custom__endpoint__url=http://${EADP_IP}:9000\n      - dataverse_files_s3_custom__endpoint__region=&#39;us-east-1&#39;\n      - dataverse_files_s3_path__style__access=True\n      - dataverse_files_s3_access__key=${PLATYS_AWS_ACCESS_KEY:?PLATYS_AWS_ACCESS_KEY must be set either in .env or as an environment variable}\n      - dataverse_files_s3_secret__key=${PLATYS_AWS_SECRET_ACCESS_KEY:?PLATYS_AWS_SECRET_ACCESS_KEY must be set either in .env or as an environment variable}\n    volumes:\n      - ./data-transfer:/data-transfer\n    restart: unless-stopped\n</code></pre></div>\n<div class=\"codehilite\"><pre><span></span><code>$ curl -s -X GET -H &#39;X-Dataverse-key: REDACTED&#39; &#39;http://192.168.116.137:28294/api/admin/dataverse/storageDrivers&#39; | jq\n{\n  &quot;status&quot;: &quot;OK&quot;,\n  &quot;data&quot;: {\n    &quot;Object Storage&quot;: &quot;s3&quot;,\n    &quot;Local Filesystem&quot;: &quot;file1&quot;\n  }\n}\n</code></pre></div>\n<p>Guess it was the space in the label (- dataverse_files_s3c_label=Real S3) in your case, which caused an error.</p>",
        "id": 398893831,
        "sender_full_name": "Guido Schmutz",
        "timestamp": 1698411473
    },
    {
        "content": "<p>Ah, right. I caught that later, the space problem, in the context of the JVM_ARGS. I'll try it again. Thanks!</p>",
        "id": 398894054,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1698411555
    },
    {
        "content": "<p>I set up S3 testing at <a href=\"https://github.com/gdcc/api-test-runner/actions/workflows/s3.yml\">https://github.com/gdcc/api-test-runner/actions/workflows/s3.yml</a></p>",
        "id": 400733361,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1699361588
    },
    {
        "content": "<p>After some fiddling, it seems to work fine.</p>",
        "id": 400733421,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1699361610
    },
    {
        "content": "<p>So my thought is that once we merge <a href=\"https://github.com/IQSS/dataverse/issues/10044\">#10044</a>, we'll copy the config I added over to the \"develop\" and \"manual\" jobs. (And eventually the \"alpha\" job, once we make a release.)</p>",
        "id": 400733656,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1699361686
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> heads up that I just added test for direct download (and non-direct download): <a href=\"https://github.com/IQSS/dataverse/pull/10044/commits/c2d8ae54a98b850f6ac9f94fa799b36bf8acaa6c\">https://github.com/IQSS/dataverse/pull/10044/commits/c2d8ae54a98b850f6ac9f94fa799b36bf8acaa6c</a></p>",
        "id": 400967531,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1699457256
    },
    {
        "content": "<p>Here's the change I made on the API test runner side: <a href=\"https://github.com/gdcc/api-test-runner/commit/02c815908480e571d28d8d47ccbc4456979b377e\">https://github.com/gdcc/api-test-runner/commit/02c815908480e571d28d8d47ccbc4456979b377e</a></p>",
        "id": 400967588,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1699457276
    },
    {
        "content": "<p>I just kicked off <a href=\"https://github.com/gdcc/api-test-runner/actions/runs/6800385363\">https://github.com/gdcc/api-test-runner/actions/runs/6800385363</a> to test it.</p>",
        "id": 400967671,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1699457290
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598112\">Philip Durbin</span> <a href=\"#narrow/stream/375812-containers/topic/testing.20S3/near/400967588\">said</a>:</p>\n<blockquote>\n<p>Here's the change I made on the API test runner side: <a href=\"https://github.com/gdcc/api-test-runner/commit/02c815908480e571d28d8d47ccbc4456979b377e\">https://github.com/gdcc/api-test-runner/commit/02c815908480e571d28d8d47ccbc4456979b377e</a></p>\n</blockquote>\n<p>I can tell Dataverse-Ansible not to template ~dataverse/.aws/credentials (and config) though it gets severely ticked when I rename it. Is Dataverse preferring global AWS creds to datastore-defined credentials expected, and do we want to open an issue to change this order?</p>",
        "id": 406087617,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1701791466
    },
    {
        "content": "<p>Good questions. I'm not sure. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 406087752,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701791510
    },
    {
        "content": "<p>maybe a question for tech hours this afternoon?</p>",
        "id": 406087960,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1701791563
    },
    {
        "content": "<p>yes, excellent idea</p>",
        "id": 406088004,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701791576
    },
    {
        "content": "<p>I mean, I _can_ nuke that file just for testing runs, but that won't address any installation with multiple datastores who expect / need a global credential file as well.</p>",
        "id": 406088120,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1701791612
    },
    {
        "content": "<p>right, it sure smells like a bug</p>",
        "id": 406088157,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701791624
    },
    {
        "content": "<p>ah. I remember now. Jim's PR corrects credentials preference when RBAC is involved. Won't affect conf file vs. jvm-option precedence.</p>",
        "id": 406088487,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1701791721
    },
    {
        "content": "<p>Meanwhile, following the tweaks I just made to the tests (changing the access and secret keys to match Jenkins), the <a href=\"https://github.com/gdcc/api-test-runner/actions/runs/7102749970\">first manual run</a> on the API test runner failed but I'm hoping it's transient. I kicked off a <a href=\"https://github.com/gdcc/api-test-runner/actions/runs/7103204154\">second run</a>.</p>",
        "id": 406088685,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701791770
    },
    {
        "content": "<p>Bah, the second run failed with the same error:</p>\n<p>Error:    S3AccessIT.setUp:66 Â» SdkClient Unable to execute HTTP request: Connect to s3.localhost.localstack.cloud:4566 [s3.localhost.localstack.cloud/127.0.0.1] failed: Connection refused</p>",
        "id": 406109728,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701796945
    },
    {
        "content": "<p>I left my instance up from this morning if you want to test anything further. If not, I'll kill it to save y'all $$$</p>",
        "id": 406114315,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1701798626
    },
    {
        "content": "<p>sounds like we want Jim's PR merged and then everything should start to work (at least WRT S3 creds). Ima kill this morning's EC2 instance.</p>",
        "id": 406122554,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1701801498
    },
    {
        "content": "<p>That's fine. When do we merge the Ansible branch?</p>",
        "id": 406125100,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701802471
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598112\">Philip Durbin</span> <a href=\"#narrow/stream/375812-containers/topic/testing.20S3/near/406125100\">said</a>:</p>\n<blockquote>\n<p>That's fine. When do we merge the Ansible branch?</p>\n</blockquote>\n<p>I'd say we merge Jim's PR, then merge that into your S3 testing branch, let me test manually once more, and we'll see if things run cleanly? (they should)</p>",
        "id": 406149528,
        "sender_full_name": "Don Sizemore",
        "timestamp": 1701806403
    },
    {
        "content": "<p><a href=\"/user_uploads/53090/j2-jHLug3fdZBYDywnjqPl2n/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/j2-jHLug3fdZBYDywnjqPl2n/image.png\" title=\"image.png\"><img src=\"/user_uploads/53090/j2-jHLug3fdZBYDywnjqPl2n/image.png\"></a></div>",
        "id": 406149651,
        "sender_full_name": "Juan Pablo Tosca Villanueva",
        "timestamp": 1701806444
    },
    {
        "content": "<p>Sounds good, and meanwhile, I'll try to figure out while I'm getting that \"s3.localhost.localstack.cloud:4566... Connection refused\" error, which JP points out is the same he saw when <a href=\"https://github.com/IQSS/dataverse/pull/10044#issuecomment-1836740149\">not on VPN</a>. Makes no sense to me. <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 406151275,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701807059
    },
    {
        "content": "<p>S3 priorities has been merged! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <a href=\"https://github.com/IQSS/dataverse/issues/10004\">#10004</a></p>",
        "id": 406334854,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701877935
    },
    {
        "content": "<p>Meanwhile, I'm still looking at the connection refused error. It's when I list the buckets, which is optional, so I <a href=\"https://github.com/IQSS/dataverse/pull/10044/commits/a81ad72a0896073e043ee57848e571d7a3754a8a\">commented that out</a> to see if/when LocalStack fails later. Here's the run: <a href=\"https://github.com/gdcc/api-test-runner/actions/runs/7116920717\">https://github.com/gdcc/api-test-runner/actions/runs/7116920717</a></p>",
        "id": 406335021,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701877988
    },
    {
        "content": "<p>Ok, I think I figured out the problem. I hope so. Re-running tests now.</p>",
        "id": 406370047,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701890143
    },
    {
        "content": "<p>Phew, yes, passing now: <a href=\"https://github.com/gdcc/api-test-runner/actions/runs/7118949044\">https://github.com/gdcc/api-test-runner/actions/runs/7118949044</a></p>",
        "id": 406370734,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701890445
    },
    {
        "content": "<p>next up: Jenkins!</p>",
        "id": 406370857,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701890490
    },
    {
        "content": "<p>I had confused myself with the api-test-runner. For now, until we merge, I set up a dedicated S3 job. Once we merge I'll put that extra config in the \"develop\" job. And once we release, into the \"alpha\" job.</p>",
        "id": 406383901,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701895312
    },
    {
        "content": "<p>The config basically spins up LocalStack and MinIO and tells Dataverse to use them.</p>",
        "id": 406383986,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701895339
    },
    {
        "content": "<p>docker compose stuff</p>",
        "id": 406384012,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701895347
    },
    {
        "content": "<p>like I'm using locally, a slight variation on that</p>",
        "id": 406384072,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701895365
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> I'm looking now at <a href=\"https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible/pull/337\">https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible/pull/337</a> . Thanks!! <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span></p>",
        "id": 406388406,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701896634
    },
    {
        "content": "<p>This is very exciting. So Docker-y!</p>",
        "id": 406388513,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701896663
    },
    {
        "content": "<p><a href=\"/user_uploads/53090/gjvqeu7QmCIdsrx-mT0QD7xo/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/gjvqeu7QmCIdsrx-mT0QD7xo/image.png\" title=\"image.png\"><img src=\"/user_uploads/53090/gjvqeu7QmCIdsrx-mT0QD7xo/image.png\"></a></div>",
        "id": 406389341,
        "sender_full_name": "Juan Pablo Tosca Villanueva",
        "timestamp": 1701896929
    },
    {
        "content": "<p>Speaking about Doker, I broke their website this morning and I had to share their error page</p>",
        "id": 406389369,
        "sender_full_name": "Juan Pablo Tosca Villanueva",
        "timestamp": 1701896943
    },
    {
        "content": "<p>We need that icon <span aria-label=\"laughter tears\" class=\"emoji emoji-1f602\" role=\"img\" title=\"laughter tears\">:laughter_tears:</span></p>",
        "id": 406389391,
        "sender_full_name": "Juan Pablo Tosca Villanueva",
        "timestamp": 1701896960
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"626369\">@Don Sizemore</span> approved! Thank you!!</p>",
        "id": 406389798,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701897079
    },
    {
        "content": "<p>All tests are passing! Including the new S3 tests! <a href=\"https://jenkins.dataverse.org/job/IQSS-Dataverse-Develop-PR/job/PR-10044/17/testReport/edu.harvard.iq.dataverse.api/S3AccessIT/\">https://jenkins.dataverse.org/job/IQSS-Dataverse-Develop-PR/job/PR-10044/17/testReport/edu.harvard.iq.dataverse.api/S3AccessIT/</a></p>",
        "id": 406551255,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701958569
    },
    {
        "content": "<p>And now I can see code coverage! 35% for S3AccessIO! <a href=\"https://jenkins.dataverse.org/job/IQSS-Dataverse-Develop-PR/job/PR-10044/17/execution/node/3/ws/target/coverage-it/edu.harvard.iq.dataverse.dataaccess/S3AccessIO.html\">https://jenkins.dataverse.org/job/IQSS-Dataverse-Develop-PR/job/PR-10044/17/execution/node/3/ws/target/coverage-it/edu.harvard.iq.dataverse.dataaccess/S3AccessIO.html</a></p>",
        "id": 406551334,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701958594
    },
    {
        "content": "<p>Could be better but I'm happy it's higher than what we had with only unit tests, 7%.</p>",
        "id": 406551469,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1701958636
    }
]