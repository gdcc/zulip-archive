[
    {
        "content": "<p>Hitting some troubles with moving existing envs to s3fs. The gameplan:</p>\n<ol>\n<li>Mount s3 bucket to local folder via s3fs</li>\n<li>Copy existing stuff on existing Dataverse folder to mount, keeping file/folder structure intact.</li>\n<li>Since java talks to operating system file system - if I replace the Dataverse data folder with the mount, it should work out of the box.</li>\n<li>Replace via fstab, reboot</li>\n<li>Mount works, files are accessible via cli.</li>\n<li>Beer</li>\n</ol>\n<p>Step 6 is interrupted unfortunately, because I'm seeing IOErrors when opening and uploading files:</p>\n<div class=\"codehilite\"><pre><span></span><code>[#|2023-10-11T14:35:32.161+0200|WARNING|Payara 5.2022.3|edu.harvard.iq.dataverse.dataaccess.ImageThumbConverter|_ThreadID=95;_ThreadName=http-thread-pool::jk-connector(1);_TimeMillis=1697027732161;_LevelValue=900;|\n  caught IOException trying to open an input stream for file://18b13f045f2-ef595f3a5aa6java.io.IOException: Failed to open local file file:///data/dataverse/files/10.5072/TAR/Y05ZDI/18b13f045f2-ef595f3a5aa6|#]\n\n[#|2023-10-11T14:35:45.004+0200|SEVERE|Payara 5.2022.3|edu.harvard.iq.dataverse.util.FileUtil|_ThreadID=98;_ThreadName=http-thread-pool::jk-connector(4);_TimeMillis=1697027745004;_LevelValue=1000;|\n  Failed to create filesTempDirectory: /data/dataverse/files/temp|#]\n\n[#|2023-10-11T14:35:45.004+0200|WARNING|Payara 5.2022.3|edu.harvard.iq.dataverse.EditDatafilesPage|_ThreadID=98;_ThreadName=http-thread-pool::jk-connector(4);_TimeMillis=1697027745004;_LevelValue=900;|\n  Failed to process and/or save the file blank_template_melting_bard.jpg; Temp directory is not configured.|#]\n</code></pre></div>\n<p>Thoughts? : )</p>",
        "id": 396081662,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697028474
    },
    {
        "content": "<p>It kind of looks like  that the S3 file sytem cannot create a folder for the temp file dir</p>",
        "id": 396083008,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697028893
    },
    {
        "content": "<p>Is it writable?</p>",
        "id": 396083060,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697028910
    },
    {
        "content": "<p>Can you actually create a directory in s3fs without any content? (In S3 AFAIK folders are just a concept like we do it in Dataverse, it's metadata of a file object)</p>",
        "id": 396083169,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697028953
    },
    {
        "content": "<p>I'm not sure about the first one</p>",
        "id": 396083230,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697028965
    },
    {
        "content": "<p>That could come from different things...</p>",
        "id": 396083271,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697028980
    },
    {
        "content": "<p>Yeap, can confirm if I just use <code>mkdir</code> on the mount directly.</p>",
        "id": 396083336,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697029005
    },
    {
        "content": "<p>Not sure how your config and your mounts look like...</p>",
        "id": 396083353,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697029011
    },
    {
        "content": "<p>Also as user dataverse?</p>",
        "id": 396083379,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697029021
    },
    {
        "content": "<p>(Or payara, as we might talk containers)</p>",
        "id": 396083409,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697029030
    },
    {
        "content": "<p>I'm debugging with umask at 000 at present, shouldn't be a permission issue (though can be). It's a thread to pull at.</p>",
        "id": 396083537,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697029083
    },
    {
        "content": "<p>I am tempted to move this to <a class=\"stream\" data-stream-id=\"378866\" href=\"/#narrow/stream/378866-troubleshooting\">#troubleshooting</a> ... It's not a dev topic (yet?)</p>",
        "id": 396083580,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697029089
    },
    {
        "content": "<p>Yes, please move.</p>",
        "id": 396083600,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697029098
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"379673\" href=\"/#narrow/stream/379673-dev/topic/S3fs.20woes\">#dev &gt; S3fs woes</a> by <span class=\"user-mention silent\" data-user-id=\"598183\">Oliver Bertuch</span>.</p>",
        "id": 396083613,
        "sender_full_name": "Notification Bot",
        "timestamp": 1697029104
    },
    {
        "content": "<p>Apologies for creating it here in the first place : )</p>",
        "id": 396083626,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697029107
    },
    {
        "content": "<p>Apologies for starting in dev in the first place.</p>",
        "id": 396083673,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697029125
    },
    {
        "content": "<p>I briefly am about to get yelled at, brb after this.</p>",
        "id": 396083702,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697029134
    },
    {
        "content": "<p><a href=\"#narrow/stream/378866-troubleshooting/topic/S3fs.20woes/near/396083626\">A message</a> was moved here from <a class=\"stream-topic\" data-stream-id=\"379673\" href=\"/#narrow/stream/379673-dev/topic/S3fs.20woes\">#dev &gt; S3fs woes</a> by <span class=\"user-mention silent\" data-user-id=\"598183\">Oliver Bertuch</span>.</p>",
        "id": 396083710,
        "sender_full_name": "Notification Bot",
        "timestamp": 1697029136
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"601950\">Thomas van Erven</span> <a href=\"#narrow/stream/378866-troubleshooting/topic/S3fs.20woes/near/396083537\">said</a>:</p>\n<blockquote>\n<p>I'm debugging with umask at 000 at present, shouldn't be a permission issue (though can be). It's a thread to pull at.</p>\n</blockquote>\n<p>Well what happens in the background is that if you upload a file and the temp dir does not yet exist, it will create it for you before storing the upload for further processing</p>",
        "id": 396083999,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697029224
    },
    {
        "content": "<p>So if Dataverse cannot create this directory for you, but you can directories on the mounted FS, this certainly indicates some sort of permission problem</p>",
        "id": 396084131,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697029266
    },
    {
        "content": "<p>Temp directory exists; it booms at creating the file.</p>",
        "id": 396094736,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697032533
    },
    {
        "content": "<p>Side note; when in a discussion with management, do not say \"of course management idea quality is poor, I wouldn't expect anything else from management\". <span aria-label=\"smiling face with tear\" class=\"emoji emoji-1f972\" role=\"img\" title=\"smiling face with tear\">:smiling_face_with_tear:</span></p>",
        "id": 396094908,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697032579
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"601950\">Thomas van Erven</span> <a href=\"#narrow/stream/378866-troubleshooting/topic/S3fs.20woes/near/396094736\">said</a>:</p>\n<blockquote>\n<p>Temp directory exists; it booms at creating the file.</p>\n</blockquote>\n<p>That's not what the error message is telling us...? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 396096698,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697033081
    },
    {
        "content": "<p>The error sits on a throne of lies:</p>\n<div class=\"codehilite\"><pre><span></span><code>[#|2023-10-11T16:15:03.480+0200|SEVERE|Payara 5.2022.3|edu.harvard.iq.dataverse.util.FileUtil|_ThreadID=96;_ThreadName=http-thread-pool::jk-connector(2);_TimeMillis=1697033703480;_LevelValue=1000;|\n  Failed to create filesTempDirectory: /data/dataverse/files/temp|#]\n\n[#|2023-10-11T16:15:03.480+0200|WARNING|Payara 5.2022.3|edu.harvard.iq.dataverse.EditDatafilesPage|_ThreadID=96;_ThreadName=http-thread-pool::jk-connector(2);_TimeMillis=1697033703480;_LevelValue=900;|\n  Failed to process and/or save the file DeanSpencer-spotcol-dwarfforge.jpg; Temp directory is not configured.|#]\n\n[root@tar31 temp]# pwd\n/data/dataverse/files/temp\n</code></pre></div>",
        "id": 396099188,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697033748
    },
    {
        "content": "<p>However, you gave me an excellent idea. Ownership.</p>",
        "id": 396099509,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697033829
    },
    {
        "content": "<p>As concept, not as a file property, you understand )</p>",
        "id": 396099558,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697033844
    },
    {
        "content": "<p>See that's why I am introducing the startup checks in <a href=\"https://github.com/IQSS/dataverse/pull/9819\">https://github.com/IQSS/dataverse/pull/9819</a></p>",
        "id": 396099813,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1697033909
    },
    {
        "content": "<p>I'm glad the yelling was brief! <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 396101905,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1697034478
    },
    {
        "content": "<p>It wasn't permission issue either.</p>",
        "id": 396107504,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697036121
    },
    {
        "content": "<p>But; I've got a slightly different error, which suggests it might be rights orientated.</p>",
        "id": 396107584,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697036150
    },
    {
        "content": "<p>You were correct; it works now. Topic may be resolved.</p>",
        "id": 396859454,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697448365
    },
    {
        "content": "<p>(As a side note; the dataverse file behaviours for temp/draft/final take quite long in terms of the interface that keeps loading, for large files and larger sets of files. I suspect I'm going to consult your migration scripts and use the Keystone implementation directly, rather than a fuse mount).</p>",
        "id": 396859791,
        "sender_full_name": "Thomas van Erven",
        "timestamp": 1697448485
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"601950\">Thomas van Erven</span> has marked this topic as resolved.</p>",
        "id": 396911160,
        "sender_full_name": "Notification Bot",
        "timestamp": 1697465228
    }
]