[
    {
        "content": "<p>We have this dataset with a DRAFT version. When user is trying to Pubilsh via UI or API its getting locked with finalizePublication. In server logs I see the following error </p>\n<div class=\"codehilite\"><pre><span></span><code>Caused by: Exception [EclipseLink-4002] (Eclipse Persistence Services - 4.0.1.payara-p2.v202310250827): org.eclipse.persistence.exceptions.DatabaseException\nInternal Exception: org.postgresql.util.PSQLException: ERROR: duplicate key value violates unique constraint \"unq_datasetversion_0\"\n  Detail: Key (dataset_id, versionnumber, minorversionnumber)=(685036, 1, 0) already exists.\nError Code: 0\nCall: UPDATE DATASETVERSION SET MINORVERSIONNUMBER = ?, VERSIONNUMBER = ?, VERSION = ? WHERE ((ID = ?) AND (VERSION = ?))\n        bind =&gt; [5 parameters bound]\nQuery: UpdateObjectQuery([DatasetVersion id:51478])\n        at org.eclipse.persistence.exceptions.DatabaseException.sqlException(DatabaseException.java:343)\n        at org.eclipse.persistence.internal.databaseaccess.DatabaseAccessor.processExceptionForCommError(DatabaseAccessor.java:1805)\n        at org.eclipse.persistence.internal.databaseaccess.DatabaseAccessor.executeDirectNoSelect(DatabaseAccessor.java:917)\n        at org.eclipse.persistence.internal.databaseaccess.DatabaseAccessor.executeNoSelect(DatabaseAccessor.java:981)\n        at org.eclipse.persistence.internal.databaseaccess.DatabaseAccessor.basicExecuteCall(DatabaseAccessor.java:642)\n        at org.eclipse.persistence.internal.databaseaccess.DatabaseAccessor.executeCall(DatabaseAccessor.java:569)\n        at org.eclipse.persistence.internal.sessions.AbstractSession.basicExecuteCall(AbstractSession.java:2048)\n        at org.eclipse.persistence.sessions.server.ClientSession.executeCall(ClientSession.java:311)\n        at org.eclipse.persistence.internal.queries.DatasourceCallQueryMechanism.executeCall(DatasourceCallQueryMechanism.java:280)\n        at org.eclipse.persistence.internal.queries.DatasourceCallQueryMechanism.executeCall(DatasourceCallQueryMechanism.java:266)\n        at org.eclipse.persistence.internal.queries.DatasourceCallQueryMechanism.updateObject(DatasourceCallQueryMechanism.java:899)\n        at org.eclipse.persistence.internal.queries.StatementQueryMechanism.updateObject(StatementQueryMechanism.java:479)\n        at org.eclipse.persistence.internal.queries.DatabaseQueryMechanism.updateObjectForWriteWithChangeSet(DatabaseQueryMechanism.java:1161)\n        at org.eclipse.persistence.queries.UpdateObjectQuery.executeCommitWithChangeSet(UpdateObjectQuery.java:88)\n        at org.eclipse.persistence.internal.queries.DatabaseQueryMechanism.executeWriteWithChangeSet(DatabaseQueryMechanism.java:326)\n        at org.eclipse.persistence.queries.WriteObjectQuery.executeDatabaseQuery(WriteObjectQuery.java:61)\n        at org.eclipse.persistence.queries.DatabaseQuery.execute(DatabaseQuery.java:913)\n        at org.eclipse.persistence.queries.DatabaseQuery.executeInUnitOfWork(DatabaseQuery.java:812)\n        at org.eclipse.persistence.queries.ObjectLevelModifyQuery.executeInUnitOfWorkObjectLevelModifyQuery(ObjectLevelModifyQuery.java:109)\n        at org.eclipse.persistence.queries.ObjectLevelModifyQuery.executeInUnitOfWork(ObjectLevelModifyQuery.java:86)\n        at org.eclipse.persistence.internal.sessions.UnitOfWorkImpl.internalExecuteQuery(UnitOfWorkImpl.java:3008)\n        at org.eclipse.persistence.internal.sessions.AbstractSession.executeQuery(AbstractSession.java:1841)\n        at org.eclipse.persistence.internal.sessions.AbstractSession.executeQuery(AbstractSession.java:1823)\n        at org.eclipse.persistence.internal.sessions.AbstractSession.executeQuery(AbstractSession.java:1773)\n        at org.eclipse.persistence.internal.sessions.CommitManager.commitChangedObjectsForClassWithChangeSet(CommitManager.java:294)\n        at org.eclipse.persistence.internal.sessions.CommitManager.commitAllObjectsWithChangeSet(CommitManager.java:152)\n        at org.eclipse.persistence.internal.sessions.AbstractSession.writeAllObjectsWithChangeSet(AbstractSession.java:4335)\n        at org.eclipse.persistence.internal.sessions.UnitOfWorkImpl.commitToDatabase(UnitOfWorkImpl.java:1507)\n        at org.eclipse.persistence.internal.sessions.UnitOfWorkImpl.commitToDatabaseWithChangeSet(UnitOfWorkImpl.java:1597)\n        at org.eclipse.persistence.internal.sessions.UnitOfWorkImpl.issueSQLbeforeCompletion(UnitOfWorkImpl.java:3305)\n        at org.eclipse.persistence.internal.sessions.RepeatableWriteUnitOfWork.issueSQLbeforeCompletion(RepeatableWriteUnitOfWork.java:368)\n        at org.eclipse.persistence.transaction.AbstractSynchronizationListener.beforeCompletion(AbstractSynchronizationListener.java:163)\n        ... 124 more\nCaused by: org.postgresql.util.PSQLException: ERROR: duplicate key value violates unique constraint \"unq_datasetversion_0\"\n  Detail: Key (dataset_id, versionnumber, minorversionnumber)=(685036, 1, 0) already exists.\n        at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2733)\n        at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:2420)\n        at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:372)\n        at org.postgresql.jdbc.PgStatement.executeInternal(PgStatement.java:517)\n        at org.postgresql.jdbc.PgStatement.execute(PgStatement.java:434)\n        at org.postgresql.jdbc.PgPreparedStatement.executeWithFlags(PgPreparedStatement.java:194)\n        at org.postgresql.jdbc.PgPreparedStatement.executeUpdate(PgPreparedStatement.java:155)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:568)\n        at org.postgresql.ds.PGPooledConnection$StatementHandler.invoke(PGPooledConnection.java:447)\n        at jdk.proxy92/jdk.proxy92.$Proxy552.executeUpdate(Unknown Source)\n        at com.sun.gjc.spi.base.PreparedStatementWrapper.executeUpdate(PreparedStatementWrapper.java:127)\n        at org.eclipse.persistence.internal.databaseaccess.DatabaseAccessor.executeDirectNoSelect(DatabaseAccessor.java:909)\n        ... 153 more\n]]\n</code></pre></div>\n<p>Following is output from datasetversion table with dataset_id of original dataset. <br>\n<code>DatasetVersion id:51478</code> is the DRAFT dataset in this image</p>\n<p><a href=\"/user_uploads/53090/gUenLvWCfwsRWtcO1SE4cau-/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/gUenLvWCfwsRWtcO1SE4cau-/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"3822x464\" src=\"/user_uploads/thumbnail/53090/gUenLvWCfwsRWtcO1SE4cau-/image.png/840x560.webp\"></a></div>",
        "id": 536665435,
        "sender_full_name": "Bikram",
        "timestamp": 1756406690
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin ðŸš€</span> <br>\nAny idea about this issue?</p>",
        "id": 536806533,
        "sender_full_name": "Bikram",
        "timestamp": 1756479348
    },
    {
        "content": "<p>Sorry, I was out a couple days but this is on my list!</p>",
        "id": 537554194,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1756933479
    },
    {
        "content": "<p><code>Key (dataset_id, versionnumber, minorversionnumber)=(685036, 1, 0) already exists</code> makes me think that version 1.0 of that dataset id already exists but a new draft is trying to be saved also as 1.0 instead of 1.1 or 1.2. Is that possible?</p>",
        "id": 537554408,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1756933565
    },
    {
        "content": "<p>Yes, that's what it looks like, its trying to publish new version with 1.0 rather than 2.0</p>",
        "id": 537686968,
        "sender_full_name": "Bikram",
        "timestamp": 1756996277
    },
    {
        "content": "<p>Hmm, is there anything exotic about this dataset that would put it in this strange state? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 537693428,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1756998006
    }
]