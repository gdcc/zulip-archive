[
    {
        "content": "<p>Hi all, <br>\nsince upgrading to dataverse 6.9 we encounter a very odd bug in our installation. When someone creates a new dataset and (for whatever reason) deletes it straight away the UI displays an \"internal server error\" and we find a warning in the payara logs.<br>\n<a href=\"/user_uploads/53090/-E53r6eNaZF9PYFJGewo11Qq/Screenshot-From-2026-01-23-11-48-33.png\">UI error</a><br>\n<a href=\"/user_uploads/53090/HoeH9nP38PJSwNcjbv5Aro12/Screenshot-From-2026-01-23-11-27-28.png\">payara log</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/-E53r6eNaZF9PYFJGewo11Qq/Screenshot-From-2026-01-23-11-48-33.png\" title=\"UI error\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1234x430\" src=\"/user_uploads/thumbnail/53090/-E53r6eNaZF9PYFJGewo11Qq/Screenshot-From-2026-01-23-11-48-33.png/840x560.webp\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/53090/HoeH9nP38PJSwNcjbv5Aro12/Screenshot-From-2026-01-23-11-27-28.png\" title=\"payara log\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1711x165\" src=\"/user_uploads/thumbnail/53090/HoeH9nP38PJSwNcjbv5Aro12/Screenshot-From-2026-01-23-11-27-28.png/840x560.webp\"></a></div><p>The same error occurs sometimes when the last dataset inside of a collection is deleted<br>\n<a href=\"/user_uploads/53090/KwdeV-XnXdLVz28iOBYUdxfD/Screenshot-From-2026-01-23-11-47-35.png\">last dataset</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/KwdeV-XnXdLVz28iOBYUdxfD/Screenshot-From-2026-01-23-11-47-35.png\" title=\"last dataset\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1175x535\" src=\"/user_uploads/thumbnail/53090/KwdeV-XnXdLVz28iOBYUdxfD/Screenshot-From-2026-01-23-11-47-35.png/840x560.webp\"></a></div><p>By debugging we ended at DatasetPage.java lines 3130-3136<br>\n<a href=\"/user_uploads/53090/VdjUZf5xhrMzeP7_rUkAuMXO/Bildschirmfoto-vom-2026-01-16-09-58-10.png\">debugging</a><br>\nWe are out of ideas how to proceed to find the root cause of the bug and fix it. Any hints are highly appreciated.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/VdjUZf5xhrMzeP7_rUkAuMXO/Bildschirmfoto-vom-2026-01-16-09-58-10.png\" title=\"debugging\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1992x1168\" src=\"/user_uploads/thumbnail/53090/VdjUZf5xhrMzeP7_rUkAuMXO/Bildschirmfoto-vom-2026-01-16-09-58-10.png/840x560.webp\"></a></div>",
        "id": 569687569,
        "sender_full_name": "BjÃ¶rn Selent",
        "timestamp": 1769165890
    },
    {
        "content": "<p>The problem with getting a clue about what's going on is related to how exceptions are treated in EJBs. Unless you throw custom exceptions that are annotated as being an @ApplicationException, EJB will always wrap any bubbling exceptions into their own (making sure it handles transaction rollbacks properly). So the log output you screenshotted is good, but there should be more related output around it regarding the exception with a root cause. Can you please add that output as well? (Also, please don't be afraid to paste them instead of a screenshot. Makes reading them easier sometimes.)</p>",
        "id": 569693533,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1769167837
    },
    {
        "content": "<p>I tried to reproduce this problem with a freshly deployed local Dataverse instance (using containers). I wasn't able to trigger the seen behaviour for an unpublished dataset nor for an unpublished dataset  version.</p>",
        "id": 569703500,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1769171478
    },
    {
        "content": "<p>I did not add any files to the dataset though... Your debugging so far may suggest this is related to File IO. (It's always good to confirm this to limit the possibilities where a bug may be hiding.)</p>",
        "id": 569703652,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1769171531
    },
    {
        "content": "<p>Hi, thanks for getting back. We also tried with a fresh install and could not reproduce the error. Importing our db also didn't trigger the bug. We think it might be related to indexing. Here is the output form the payara logs anyways:</p>\n<div class=\"codehilite\"><pre><span></span><code>[2026-01-23T11:47:51.382+0100] [Payara 6.2025.10] [WARNING] [AS-EJB-00056] [jakarta.enterprise.ejb.container] [tid: _ThreadID=102 _ThreadName=http-thread-pool::jk-connector(2)] [timeMillis: 1769165271382] [levelValue: 900] [[\n  A system exception occurred during an invocation on EJB PermissionServiceBean, method: public edu.harvard.iq.dataverse.PermissionServiceBean$RequestPermissionQuery edu.harvard.iq.dataverse.PermissionServiceBean.requestOn(edu.harvard.iq.dataverse.engine.command.DataverseRequest,edu.harvard.iq.dataverse.DvObject)]]\n\n[2026-01-23T11:47:51.382+0100] [Payara 6.2025.10] [WARNING] [] [jakarta.enterprise.ejb.container] [tid: _ThreadID=102 _ThreadName=http-thread-pool::jk-connector(2)] [timeMillis: 1769165271382] [levelValue: 900] [[\n\njakarta.ejb.EJBException\n    at com.sun.ejb.containers.EJBContainerTransactionManager.processSystemException(EJBContainerTransactionManager.java:723)\n    at com.sun.ejb.containers.EJBContainerTransactionManager.completeNewTx(EJBContainerTransactionManager.java:652)\n    at com.sun.ejb.containers.EJBContainerTransactionManager.postInvokeTx(EJBContainerTransactionManager.java:482)\n    at com.sun.ejb.containers.BaseContainer.postInvokeTx(BaseContainer.java:4601)\n    at com.sun.ejb.containers.BaseContainer.postInvoke(BaseContainer.java:2134)\n    at com.sun.ejb.containers.BaseContainer.postInvoke(BaseContainer.java:2104)\n    at com.sun.ejb.containers.EJBLocalObjectInvocationHandler.invoke(EJBLocalObjectInvocationHandler.java:220)\n    at com.sun.ejb.containers.EJBLocalObjectInvocationHandlerDelegate.invoke(EJBLocalObjectInvocationHandlerDelegate.java:90)\n    at jdk.proxy71/jdk.proxy71.$Proxy407.requestOn(Unknown Source)\n    at edu.harvard.iq.dataverse.__EJB31_Generated__PermissionServiceBean__Intf____Bean__.requestOn(Unknown Source)\n    at edu.harvard.iq.dataverse.PermissionsWrapper.doesSessionUserHaveDataSetPermission(PermissionsWrapper.java:191)\n    at edu.harvard.iq.dataverse.PermissionsWrapper.canViewUnpublishedDataset(PermissionsWrapper.java:154)\n    at edu.harvard.iq.dataverse.PermissionsWrapper$Proxy$_$$_WeldClientProxy.canViewUnpublishedDataset(Unknown Source)\n    at edu.harvard.iq.dataverse.search.SearchIncludeFragment.canSeeCurationStatus(SearchIncludeFragment.java:1559)\n    at jdk.internal.reflect.GeneratedMethodAccessor816.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at jakarta.el.ELUtil.invokeMethod(ELUtil.java:215)\n    at jakarta.el.BeanELResolver.invoke(BeanELResolver.java:487)\n    at jakarta.el.CompositeELResolver.invoke(CompositeELResolver.java:198)\n    at org.glassfish.expressly.parser.AstValue.getValue(AstValue.java:298)\n    at org.glassfish.expressly.parser.AstValue.getValue(AstValue.java:144)\n    at org.glassfish.expressly.ValueExpressionImpl.getValue(ValueExpressionImpl.java:138)\n    at org.jboss.weld.module.web.el.WeldValueExpression.getValue(WeldValueExpression.java:50)\n    at com.sun.faces.facelets.el.TagValueExpression.getValue(TagValueExpression.java:73)\n    at jakarta.faces.component.ComponentStateHelper.eval(ComponentStateHelper.java:188)\n    at jakarta.faces.component.UIComponentBase.isRendered(UIComponentBase.java:309)\n    at com.sun.faces.renderkit.html_basic.HtmlBasicRenderer.encodeRecursive(HtmlBasicRenderer.java:250)\n    at com.sun.faces.renderkit.html_basic.PassthroughRenderer.encodeChildren(PassthroughRenderer.java:75)\n    at jakarta.faces.component.UIComponentBase.encodeChildren(UIComponentBase.java:557)\n    at com.sun.faces.renderkit.html_basic.HtmlBasicRenderer.encodeRecursive(HtmlBasicRenderer.java:257)\n    at com.sun.faces.renderkit.html_basic.TableRenderer.renderRow(TableRenderer.java:351)\n    at com.sun.faces.renderkit.html_basic.TableRenderer.encodeChildren(TableRenderer.java:135)\n    at jakarta.faces.component.UIComponentBase.encodeChildren(UIComponentBase.java:557)\n    at com.sun.faces.renderkit.html_basic.HtmlBasicRenderer.encodeRecursive(HtmlBasicRenderer.java:257)\n    at com.sun.faces.renderkit.html_basic.PassthroughRenderer.encodeChildren(PassthroughRenderer.java:75)\n    at jakarta.faces.component.UIComponentBase.encodeChildren(UIComponentBase.java:557)\n    at jakarta.faces.component.UIComponent.encodeAll(UIComponent.java:1435)\n    at jakarta.faces.component.UIComponent.encodeAll(UIComponent.java:1438)\n    at jakarta.faces.component.UIComponent.encodeAll(UIComponent.java:1438)\n    at jakarta.faces.component.UIComponent.encodeAll(UIComponent.java:1438)\n    at jakarta.faces.component.UIComponent.encodeAll(UIComponent.java:1438)\n    at com.sun.faces.application.view.FaceletViewHandlingStrategy.renderView(FaceletViewHandlingStrategy.java:448)\n    at com.sun.faces.application.view.MultiViewHandler.renderView(MultiViewHandler.java:160)\n    at jakarta.faces.application.ViewHandlerWrapper.renderView(ViewHandlerWrapper.java:125)\n    at jakarta.faces.application.ViewHandlerWrapper.renderView(ViewHandlerWrapper.java:125)\n    at jakarta.faces.application.ViewHandlerWrapper.renderView(ViewHandlerWrapper.java:125)\n    at org.omnifaces.viewhandler.OmniViewHandler.renderView(OmniViewHandler.java:151)\n    at com.sun.faces.lifecycle.RenderResponsePhase.execute(RenderResponsePhase.java:93)\n    at com.sun.faces.lifecycle.Phase.doPhase(Phase.java:72)\n    at com.sun.faces.lifecycle.LifecycleImpl.render(LifecycleImpl.java:150)\n    at jakarta.faces.webapp.FacesServlet.executeLifecyle(FacesServlet.java:692)\n    at jakarta.faces.webapp.FacesServlet.service(FacesServlet.java:449)\n    at org.apache.catalina.core.StandardWrapper.service(StandardWrapper.java:1554)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:331)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:211)\n    at org.ocpsoft.rewrite.servlet.RewriteFilter.doFilter(RewriteFilter.java:226)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:253)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:211)\n    at org.apache.catalina.core.ApplicationDispatcher.doInvoke(ApplicationDispatcher.java:816)\n    at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:683)\n    at org.apache.catalina.core.ApplicationDispatcher.processRequest(ApplicationDispatcher.java:527)\n    at org.apache.catalina.core.ApplicationDispatcher.doDispatch(ApplicationDispatcher.java:497)\n    at org.apache.catalina.core.ApplicationDispatcher.dispatch(ApplicationDispatcher.java:379)\n    at org.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:329)\n    at org.ocpsoft.rewrite.servlet.impl.HttpRewriteResultHandler.handleResult(HttpRewriteResultHandler.java:42)\n    at org.ocpsoft.rewrite.servlet.RewriteFilter.rewrite(RewriteFilter.java:297)\n    at org.ocpsoft.rewrite.servlet.RewriteFilter.doFilter(RewriteFilter.java:198)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:253)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:211)\n    at edu.harvard.iq.dataverse.filter.CorsFilter.doFilter(CorsFilter.java:89)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:253)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:211)\n    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:257)\n    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:166)\n    at org.apache.catalina.core.StandardPipeline.doInvoke(StandardPipeline.java:757)\n    at org.apache.catalina.core.StandardPipeline.invoke(StandardPipeline.java:577)\n    at com.sun.enterprise.web.WebPipeline.invoke(WebPipeline.java:99)\n    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:158)\n    at org.apache.catalina.connector.CoyoteAdapter.doService(CoyoteAdapter.java:372)\n    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:239)\n    at com.sun.enterprise.v3.services.impl.ContainerMapper$HttpHandlerCallable.call(ContainerMapper.java:520)\n    at com.sun.enterprise.v3.services.impl.ContainerMapper.service(ContainerMapper.java:217)\n    at org.glassfish.grizzly.http.server.HttpHandler.runService(HttpHandler.java:174)\n    at org.glassfish.grizzly.http.server.HttpHandler.doHandle(HttpHandler.java:153)\n    at org.glassfish.grizzly.http.server.HttpServerFilter.handleRead(HttpServerFilter.java:196)\n    at org.glassfish.grizzly.filterchain.ExecutorResolver$9.execute(ExecutorResolver.java:88)\n    at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeFilter(DefaultFilterChain.java:246)\n    at org.glassfish.grizzly.filterchain.DefaultFilterChain.executeChainPart(DefaultFilterChain.java:178)\n    at org.glassfish.grizzly.filterchain.DefaultFilterChain.execute(DefaultFilterChain.java:118)\n    at org.glassfish.grizzly.filterchain.DefaultFilterChain.process(DefaultFilterChain.java:96)\n    at org.glassfish.grizzly.ProcessorExecutor.execute(ProcessorExecutor.java:51)\n    at org.glassfish.grizzly.nio.transport.TCPNIOTransport.fireIOEvent(TCPNIOTransport.java:510)\n    at org.glassfish.grizzly.strategies.AbstractIOStrategy.fireIOEvent(AbstractIOStrategy.java:82)\n    at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy.run0(WorkerThreadIOStrategy.java:83)\n    at org.glassfish.grizzly.strategies.WorkerThreadIOStrategy$WorkerThreadRunnable.run(WorkerThreadIOStrategy.java:101)\n    at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.doWork(AbstractThreadPool.java:535)\n    at org.glassfish.grizzly.threadpool.AbstractThreadPool$Worker.run(AbstractThreadPool.java:515)\n    at java.base/java.lang.Thread.run(Thread.java:840)\nCaused by: java.lang.NullPointerException\n``\n</code></pre></div>",
        "id": 569704917,
        "sender_full_name": "BjÃ¶rn Selent",
        "timestamp": 1769171913
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"652614\">@BjÃ¶rn Selent</span> if you don't min - would you wrap your log output in a code block? (Three \"`\" ) Thanks!</p>",
        "id": 569706869,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1769172531
    },
    {
        "content": "<p>Hmm:</p>\n<p><code>Caused by: java.lang.NullPointerException</code></p>\n<p>What's null?</p>",
        "id": 569707029,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1769172574
    },
    {
        "content": "<p><code>edu.harvard.iq.dataverse.search.SearchIncludeFragment.canSeeCurationStatus(SearchIncludeFragment.java:1559)</code> is:</p>\n<div class=\"codehilite\" data-code-language=\"Java\"><pre><span></span><code><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">permissionsWrapper</span><span class=\"p\">.</span><span class=\"na\">canViewUnpublishedDataset</span><span class=\"p\">(</span><span class=\"n\">getDataverseRequest</span><span class=\"p\">(),(</span><span class=\"n\">Dataset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">dvObjectService</span><span class=\"p\">.</span><span class=\"na\">findDvObject</span><span class=\"p\">(</span><span class=\"n\">datasetId</span><span class=\"p\">));</span>\n</code></pre></div>\n<p>This would be my next stop for trying to dig deeper.</p>",
        "id": 569707185,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1769172614
    },
    {
        "content": "<p><a href=\"https://github.com/IQSS/dataverse/blob/v6.9/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java#L1559\">https://github.com/IQSS/dataverse/blob/v6.9/src/main/java/edu/harvard/iq/dataverse/search/SearchIncludeFragment.java#L1559</a></p>\n<p><code>return permissionsWrapper.canViewUnpublishedDataset(getDataverseRequest(),(Dataset) dvObjectService.findDvObject(datasetId));</code></p>\n<p>So permissionsWrapper or dvObjectService is null? That would be strange.</p>",
        "id": 569708235,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1769172921
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"652614\">@BjÃ¶rn Selent</span> if you can replicate the bug on <a href=\"https://demo.dataverse.org\">https://demo.dataverse.org</a> please give us detailed steps. I wasn't able to.</p>",
        "id": 569708364,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1769172956
    },
    {
        "content": "<p>No, I can't reproduce the bug on <a href=\"http://demo.dataverse.org\">demo.dataverse.org</a>. <br>\nBut what I can see and might be related is, that after successful deleting the dataset, it is still shown in the overview until the page is reloaded<br>\n<a href=\"/user_uploads/53090/UlYa3UUEjS6cKisv_jiJagPW/Screenshot-From-2026-01-23-13-58-26.png\">Screenshot AFTER successfully deleting the dataset</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/UlYa3UUEjS6cKisv_jiJagPW/Screenshot-From-2026-01-23-13-58-26.png\" title=\"Screenshot AFTER successfully deleting the dataset\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1203x443\" src=\"/user_uploads/thumbnail/53090/UlYa3UUEjS6cKisv_jiJagPW/Screenshot-From-2026-01-23-13-58-26.png/840x560.webp\"></a></div>",
        "id": 569709205,
        "sender_full_name": "BjÃ¶rn Selent",
        "timestamp": 1769173235
    },
    {
        "content": "<p>interesting</p>",
        "id": 569709575,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1769173345
    },
    {
        "content": "<p>Yeah, I did recognize that too!</p>",
        "id": 569711206,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1769173874
    },
    {
        "content": "<p>BTW this is also true for a draft dataset version on an already published dataset.</p>",
        "id": 569711342,
        "sender_full_name": "Oliver Bertuch",
        "timestamp": 1769173919
    },
    {
        "content": "<p>Sounds like two different bugs, potentially. <span aria-label=\"lady beetle\" class=\"emoji emoji-1f41e\" role=\"img\" title=\"lady beetle\">:lady_beetle:</span> <span aria-label=\"lady beetle\" class=\"emoji emoji-1f41e\" role=\"img\" title=\"lady beetle\">:lady_beetle:</span></p>",
        "id": 569728838,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1769178517
    }
]