[
    {
        "content": "<p>Looks like something is wrong with the demo page? <a href=\"https://demo.dataverse.org/\">https://demo.dataverse.org/</a><br>\n<a href=\"/user_uploads/53090/M364YV7vkA9JHU_eGrRLqxmm/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/M364YV7vkA9JHU_eGrRLqxmm/image.png\" title=\"image.png\"><img data-original-dimensions=\"2448x1124\" src=\"/user_uploads/thumbnail/53090/M364YV7vkA9JHU_eGrRLqxmm/image.png/840x560.webp\"></a></div>",
        "id": 488889862,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734111459
    },
    {
        "content": "<p>I really wonder if I just killed it, because it was working until now and I just tried to send a compressed TGZ archive (to test a feature for the galaxy integration). The reason is that zip files get unarchived automatically and I wanted to test if the same happens with .tgz files.</p>\n<p>This is the response I just got after I tried to upload it via API and since then the server is not responsive anymore:</p>\n<p><code>raised unexpected: Exception('Request to https://demo.dataverse.org/api/v1/datasets/:persistentId/add?persistentId=doi:10.70122/FK2/3HKFAU failed with status code 400: Failed to add file to dataset.')</code></p>",
        "id": 488890886,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734111788
    },
    {
        "content": "<p>CC <span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin ðŸš€</span></p>",
        "id": 488890922,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734111810
    },
    {
        "content": "<p><a href=\"/user_uploads/53090/VKLOAWRyyGc0q0LvIt6qgU93/reimport-test-3.tar.gz\">reimport-test-3.tar.gz</a><br>\nthis should be the file that was sent, just a tar.gz file with two images inside</p>",
        "id": 488891173,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734111882
    },
    {
        "content": "<p>page is back up apparently</p>",
        "id": 488894450,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734113026
    },
    {
        "content": "<p>Sorry, we just released Dataverse 6.5 (<a class=\"stream-topic\" data-stream-id=\"375707\" href=\"/#narrow/channel/375707-community/topic/Dataverse.206.2E5.20is.20here.21\">#community &gt; Dataverse 6.5 is here!</a> ) and were <a href=\"https://github.com/IQSS/dataverse.harvard.edu/issues/313\">updating</a> the demo site to it.</p>",
        "id": 488897573,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1734114323
    },
    {
        "content": "<p>haha okay I'm glad :D was just in exactly that moment it went down</p>",
        "id": 488974859,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734165458
    },
    {
        "content": "<p>I still get the 400 error though. Are .tar.gz files not accepted?</p>",
        "id": 488975041,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734165625
    },
    {
        "content": "<p>hmm I tested it directly via API and it uploads fine actually. I will have to investigate further what exactly Galaxy is sending.</p>\n<p><code>curl -H \"X-Dataverse-key:XXX\" -X POST -F file=@test.tar.gz \"https://demo.dataverse.org/api/datasets/:persistentId/add?persistentId=doi:10.70122/FK2/DIG2DG\"</code></p>",
        "id": 488975604,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734166208
    },
    {
        "content": "<p>It's weird, I can't see why it works with curl and not with python. I had a look at the raw requests by using both postman and python to send the post requests to <a href=\"https://httpbin.org/post\">https://httpbin.org/post</a> and the requests look virtually equal. However curl successfully uploads the file and in python I get <code>failed with status code 400: Failed to add file to dataset.</code></p>\n<p><a href=\"/user_uploads/53090/81HJur-XatLpyl-gjIUl9_Yt/Screenshot-2024-12-14-at-12.02.40.png\">Screenshot 2024-12-14 at 12.02.40.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/81HJur-XatLpyl-gjIUl9_Yt/Screenshot-2024-12-14-at-12.02.40.png\" title=\"Screenshot 2024-12-14 at 12.02.40.png\"><img data-original-dimensions=\"3154x864\" src=\"/user_uploads/thumbnail/53090/81HJur-XatLpyl-gjIUl9_Yt/Screenshot-2024-12-14-at-12.02.40.png/840x560.webp\"></a></div>",
        "id": 488984300,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734174281
    },
    {
        "content": "<p>It would be amazing if somebody could help me out with the dataverse server logs next week <span aria-label=\"folded hands\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"folded hands\">:folded_hands:</span> . I just made two requests via galaxy (python), one with the failing .tar.gz file and one with the working .zip (time is CET):</p>\n<p><code>[2024-12-14 12:10:55,328: DEBUG/main] https://demo.dataverse.org:443 \"POST /api/v1/datasets/:persistentId/add?persistentId=doi:10.70122/FK2/3HKFAU HTTP/1.1\" 400 61\n[2024-12-14 12:10:55,330: WARNING/main] RESPONSE: {'status': 'ERROR', 'message': 'Failed to add file to dataset.'}</code></p>\n<p><code>[2024-12-14 12:12:23,311: DEBUG/main] https://demo.dataverse.org:443 \"POST /api/v1/datasets/:persistentId/add?persistentId=doi:10.70122/FK2/3HKFAU HTTP/1.1\" 200 None\n[2024-12-14 12:12:23,312: WARNING/main] RESPONSE: {'status': 'OK', 'message': {'message': 'This file has the same content as test.txt_64e0efaf9500cb29.txt that is in the dataset. '} ...,</code></p>",
        "id": 488984825,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734174791
    },
    {
        "content": "<p>oh and I just made a third one, the working curl request with the .tar.gz  at 12:15 CET:</p>\n<div class=\"codehilite\"><pre><span></span><code>curl -H &quot;X-Dataverse-keyXXX&quot; -X POST -F file=@small-file-history-test.tar.gz &quot;https://demo.dataverse.org/api/datasets/:persistentId/add?persistentId=doi:10.70122/FK2/3HKFAU&quot;\n{&quot;status&quot;:&quot;OK&quot;,&quot;message&quot;:{&quot;message&quot;:&quot;This file has the same content as small-file-history-test.tar.gz that is in the dataset. &quot;},&quot;data&quot;:{&quot;files&quot;:[{&quot;description&quot;:&quot;&quot;,&quot;label&quot;:&quot;small-file-history-test.tar-3.gz&quot;,&quot;restricted&quot;:false,&quot;version&quot;:1,&quot;datasetVersionId&quot;:276019,&quot;dataFile&quot;:{&quot;id&quot;:2476460,&quot;persistentId&quot;:&quot;doi:10.70122/FK2/3HKFAU/9RJV3C&quot;,&quot;pidURL&quot;:&quot;https://doi.org/10.70122/FK2/3HKFAU/9RJV3C&quot;,&quot;filename&quot;:&quot;small-file-history-test.tar-3.gz&quot;,&quot;contentType&quot;:&quot;application/gzip&quot;,&quot;friendlyType&quot;:&quot;Gzip Archive&quot;,&quot;filesize&quot;:1894,&quot;description&quot;:&quot;&quot;,&quot;storageIdentifier&quot;:&quot;s3://demo-dataverse-org:193c4e10eff-c0474fd01718&quot;,&quot;rootDataFileId&quot;:-1,&quot;md5&quot;:&quot;f804a9a4e5f8f373dd87938ad1d01325&quot;,&quot;checksum&quot;:{&quot;type&quot;:&quot;MD5&quot;,&quot;value&quot;:&quot;f804a9a4e5f8f373dd87938ad1d01325&quot;},&quot;tabularData&quot;:false,&quot;creationDate&quot;:&quot;2024-12-14&quot;,&quot;fileAccessRequest&quot;:false}}]}}%\n</code></pre></div>",
        "id": 488985051,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734174995
    },
    {
        "content": "<p>Oh, so it wasn't the demo site being down. <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> </p>\n<p><span class=\"user-mention\" data-user-id=\"784992\">@Kai KÃ¶nig</span> what's the latest, please? It work with curl but not Python? (We might want to move this topic to <a class=\"stream\" data-stream-id=\"377090\" href=\"/#narrow/channel/377090-python\">#python</a>.)</p>\n<p>Do you want to give it a try on <a href=\"https://beta.dataverse.org\">https://beta.dataverse.org</a> ?</p>",
        "id": 489232887,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1734354741
    },
    {
        "content": "<p>yes exactly works with curl but not with python, my last messages are still the current state. I ignored this issue for now because zip upload works</p>",
        "id": 489233073,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734354789
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"375707\" href=\"/#narrow/channel/375707-community/topic/uploading.20.2Etar.2Egz.20files.20via.20API\">#community &gt; uploading .tar.gz files via API</a> by <span class=\"user-mention silent\" data-user-id=\"598112\">Philip Durbin ðŸš€</span>.</p>",
        "id": 489233418,
        "sender_full_name": "Notification Bot",
        "timestamp": 1734354899
    },
    {
        "content": "<p>Can you please show us your python script?</p>",
        "id": 489233507,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1734354928
    },
    {
        "content": "<p>Sure!</p>\n<div class=\"codehilite\"><pre><span></span><code>        with open(file_path, &quot;rb&quot;) as file:\n            files = {&#39;file&#39;: (filename, file)}\n            payload = dict()\n            add_files_url = self.add_files_to_dataset_url(dataset_id)\n            response = requests.post(\n                add_files_url,\n                data=payload,\n                files=files,\n                headers=headers)\n            self._ensure_response_has_expected_status_code(response, 200)\n</code></pre></div>\n<div class=\"codehilite\"><pre><span></span><code>def add_files_to_dataset_url(self, dataset_id: str) -&gt; str:\n        return f&quot;{self.api_base_url}/datasets/:persistentId/add?persistentId={dataset_id}&quot;\n</code></pre></div>",
        "id": 489234158,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734355108
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"784992\">@Kai KÃ¶nig</span> thanks for reaching out! I'll read through the messages an get back to you asap</p>",
        "id": 489250534,
        "sender_full_name": "Jan Range",
        "timestamp": 1734359143
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"784992\">@Kai KÃ¶nig</span> are you using pyDataverse or playin <code>requests</code>? I have just tested it using the former and everything works well using <code>tar.gz</code>. </p>\n<p><a href=\"/user_uploads/53090/2Oldnd8RXkFDRmvyNi8ZG31C/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/2Oldnd8RXkFDRmvyNi8ZG31C/image.png\" title=\"image.png\"><img data-original-dimensions=\"3456x2234\" src=\"/user_uploads/thumbnail/53090/2Oldnd8RXkFDRmvyNi8ZG31C/image.png/840x560.webp\"></a></div>",
        "id": 489253355,
        "sender_full_name": "Jan Range",
        "timestamp": 1734359861
    },
    {
        "content": "<p>When using <code>requests</code>, it's essential to provide the form-data section <code>jsonData</code> as a string. Providing it as a <code>dict</code> may lead to issues. This might explain why the <code>replace</code> endpoint didn't function correctly too.</p>\n<p>You may want to check out the <a href=\"https://github.com/gdcc/pyDataverse/blob/693d0ff8d2849eccc32f9e66228ee8976109881a/pyDataverse/api.py#L1933-L1943\">pyDataverse implementation</a> as guidance. </p>\n<p><span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin ðŸš€</span> would it make sense to mention this in the general docs or is it to specific for Python?</p>",
        "id": 489255203,
        "sender_full_name": "Jan Range",
        "timestamp": 1734360325
    },
    {
        "content": "<p>Well, dicts are Python-specific.</p>",
        "id": 489255408,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1734360370
    },
    {
        "content": "<p>Let's see if <span class=\"user-mention\" data-user-id=\"784992\">@Kai KÃ¶nig</span> is unblocked now. Thanks for helping! Then we can figure out where to highlight the fix in the docs.</p>",
        "id": 489255731,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1734360442
    },
    {
        "content": "<p>thanks guys! Will have a look at this tomorrow. If what you wrote is the source of this issue, I would find it weird anyway. Because the .zip file uses the exact same function and it works without problems there.</p>",
        "id": 489258984,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734361182
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"784992\">@Kai KÃ¶nig</span> please do feel free to open an issue at <a href=\"https://github.com/IQSS/dataverse/issues\">https://github.com/IQSS/dataverse/issues</a> about the confusion</p>",
        "id": 489259278,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1734361227
    },
    {
        "content": "<p>It depends, if you post metadata such as <code>description</code> or else, the <code>jsonData</code> field needs to be a string. Very odd, but otherwise you'll get an error. But I missed that you are in fact not passing any metadata, so that might not be relevant here - Probably in the replace case though.</p>\n<p>I have used <code>requests</code> to reproduce your error, but I was not able to. Here is the code I have been using to upload a <code>tar.gz</code> file:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">from</span> <span class=\"nn\">rich</span> <span class=\"kn\">import</span> <span class=\"nb\">print</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">json</span>\n<span class=\"kn\">import</span> <span class=\"nn\">requests</span>\n\n<span class=\"n\">pid</span> <span class=\"o\">=</span> <span class=\"s2\">\"doi:10.70122/FK2/4ZCAHN\"</span>\n<span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">\"https://demo.dataverse.org/api/datasets/:persistentId/add?persistentId=</span><span class=\"si\">{</span><span class=\"n\">pid</span><span class=\"si\">}</span><span class=\"s2\">\"</span>\n<span class=\"n\">files</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"s2\">\"file\"</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"s2\">\"some_other_name.tar.gz\"</span><span class=\"p\">,</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"s2\">\"test.tar.gz\"</span><span class=\"p\">,</span> <span class=\"s2\">\"rb\"</span><span class=\"p\">),</span> <span class=\"s2\">\"application/octet-stream\"</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">metadata</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">({</span>\n    <span class=\"s2\">\"description\"</span><span class=\"p\">:</span> <span class=\"s2\">\"Look, I am a DataFile!\"</span><span class=\"p\">,</span>\n<span class=\"p\">})</span>\n\n<span class=\"n\">headers</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s2\">\"X-Dataverse-Key\"</span><span class=\"p\">:</span> <span class=\"s2\">\"...\"</span><span class=\"p\">}</span>\n<span class=\"n\">resp</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span>\n    <span class=\"n\">url</span><span class=\"p\">,</span>\n    <span class=\"n\">files</span><span class=\"o\">=</span><span class=\"n\">files</span><span class=\"p\">,</span>\n    <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">\"jsonData\"</span><span class=\"p\">:</span> <span class=\"n\">metadata</span><span class=\"p\">},</span>\n    <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"n\">headers</span>\n<span class=\"p\">)</span>\n\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"n\">resp</span><span class=\"o\">.</span><span class=\"n\">json</span><span class=\"p\">())</span>\n</code></pre></div>\n<p><a href=\"/user_uploads/53090/emyvbNakV4hBhhjzhPsow7d1/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/emyvbNakV4hBhhjzhPsow7d1/image.png\" title=\"image.png\"><img data-original-dimensions=\"3456x2234\" src=\"/user_uploads/thumbnail/53090/emyvbNakV4hBhhjzhPsow7d1/image.png/840x560.webp\"></a></div>",
        "id": 489272866,
        "sender_full_name": "Jan Range",
        "timestamp": 1734364347
    },
    {
        "content": "<p>By the way, you get this when you don't serialize the payload to a string.</p>\n<p><a href=\"/user_uploads/53090/gQgO1pM0XkWUQcT-ZFUgaKnz/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/53090/gQgO1pM0XkWUQcT-ZFUgaKnz/image.png\" title=\"image.png\"><img data-original-dimensions=\"1676x1026\" src=\"/user_uploads/thumbnail/53090/gQgO1pM0XkWUQcT-ZFUgaKnz/image.png/840x560.webp\"></a></div>",
        "id": 489274978,
        "sender_full_name": "Jan Range",
        "timestamp": 1734364841
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"599841\">@Jan Range</span> thanks for looking into this! Well it is odd, I tried again and added <code>\"application/octet-stream\"</code> as filetype and completely removed the metadat parameter. But I still get the same error</p>",
        "id": 489435353,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734426073
    },
    {
        "content": "<p>So I guess the galaxy application is doing something to the file that makes the request fail. The server logs would definitely be helpful</p>",
        "id": 489435534,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734426127
    },
    {
        "content": "<p>but tbh, it's not a super high priority, because people can just export as zip and that works</p>",
        "id": 489435569,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734426146
    },
    {
        "content": "<p>im going to integrate the last feature and then will try wrap up the integration. If anyone provides me server logs or more insights I might look into this again.</p>",
        "id": 489435703,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734426211
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"784992\">@Kai KÃ¶nig</span> Regarding server logs, you can also host Dataverse via Docker locally.  There should be no difference to the Demo website. It helps a lot with debugging, especially when the API responses are not specific enough. You can clone the <a href=\"https://github.com/IQSS/dataverse\">main repo</a> and run the following, given <code>mvn</code> is installed:</p>\n<p><code>mvn -Pct clean package docker:start</code></p>\n<p>I usually do it that way, but <span class=\"user-mention\" data-user-id=\"598112\">@Philip Durbin ðŸš€</span> may have better approaches?</p>\n<p>Also, if you want to CI/CD test your Python library, I highly recommend using our <a href=\"https://github.com/gdcc/dataverse-action\">GitHub Action</a>. Here is an <a href=\"https://github.com/gdcc/pyDataverse/blob/main/.github/workflows/tests.yml\">example workflow</a>, which you can mostly copy-paste.</p>",
        "id": 489461866,
        "sender_full_name": "Jan Range",
        "timestamp": 1734434620
    },
    {
        "content": "<p>Thanks Jan, Im basically finished now with the integration and in my experience creating a local env always is more work as expected... Is the docker setup really easy or do I have to configure anything?</p>",
        "id": 489466502,
        "sender_full_name": "Kai KÃ¶nig",
        "timestamp": 1734436261
    },
    {
        "content": "<p>From my experience, it has always been straightforward. There was no additional configuration necessary, except for adding certain services. I just found the part in the docs, if that helps:</p>\n<p><a href=\"https://guides.dataverse.org/en/latest/container/dev-usage.html\">https://guides.dataverse.org/en/latest/container/dev-usage.html</a></p>",
        "id": 489472406,
        "sender_full_name": "Jan Range",
        "timestamp": 1734438149
    },
    {
        "content": "<p>The quickstart ( <a href=\"https://guides.dataverse.org/en/latest/developers/dev-environment.html#quickstart\">https://guides.dataverse.org/en/latest/developers/dev-environment.html#quickstart</a> ) should \"just work\" and if it doesn't, please let us know in <a class=\"stream\" data-stream-id=\"375812\" href=\"/#narrow/channel/375812-containers\">#containers</a>! <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 489477489,
        "sender_full_name": "Philip Durbin ðŸš€",
        "timestamp": 1734439781
    }
]