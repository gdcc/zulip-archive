<html>
<head><meta charset="utf-8"><title>Upload checks need optimization Â· dev Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/index.html">dev</a></h2>
<h3>Topic: <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html">Upload checks need optimization</a></h3>

<hr>

<base href="https://dataverse.zulipchat.com">

<head><link href="https://gdcc.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="542496082"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542496082" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542496082">(Oct 01 2025 at 13:31)</a>:</h4>
<p>We are not handling uploads very clever, are we? For example instead of looking at the Content Length header, we transfer the whole file and then take a look at it. Depending on the file size, that's a long turnaround time... <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="542497946"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542497946" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philip Durbin ðŸš€ <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542497946">(Oct 01 2025 at 13:38)</a>:</h4>
<p>Which system are you talking about? JSF? The SPA? dvwebloader? DVUploader? python-DVUploader?</p>



<a name="542498022"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542498022" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542498022">(Oct 01 2025 at 13:39)</a>:</h4>
<p>Backend API endpoint.</p>



<a name="542498132"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542498132" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542498132">(Oct 01 2025 at 13:39)</a>:</h4>
<p><a href="https://github.com/poikilotherm/dataverse/blob/f79a02b4ad33f4febba96ddc41278011f42a87b1/src/main/java/edu/harvard/iq/dataverse/engine/command/impl/CreateNewDataFilesCommand.java#L191-L200">https://github.com/poikilotherm/dataverse/blob/f79a02b4ad33f4febba96ddc41278011f42a87b1/src/main/java/edu/harvard/iq/dataverse/engine/command/impl/CreateNewDataFilesCommand.java#L191-L200</a></p>



<a name="542498246"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542498246" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philip Durbin ðŸš€ <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542498246">(Oct 01 2025 at 13:40)</a>:</h4>
<p>Ah, you mean for limiting the size?</p>



<a name="542498278"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542498278" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542498278">(Oct 01 2025 at 13:40)</a>:</h4>
<p>Aye</p>



<a name="542498447"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542498447" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philip Durbin ðŸš€ <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542498447">(Oct 01 2025 at 13:40)</a>:</h4>
<p>Hmm, I think you're right about that code but maybe I'm missing something. <span class="user-mention" data-user-id="637063">@Leo Andreev</span> can you please comment?</p>



<a name="542498772"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542498772" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542498772">(Oct 01 2025 at 13:42)</a>:</h4>
<p>We don't even need to have a fancy JAX-RS ContainerFilter in place. I assume we could just access the HTTP headers via the DataverseRequest.</p>



<a name="542498998"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542498998" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542498998">(Oct 01 2025 at 13:42)</a>:</h4>
<p>Although I'm not sure this would actually stop transfering the data. A filter may be necessary to interrupt the process early.</p>



<a name="542571289"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542571289" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leo Andreev <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542571289">(Oct 01 2025 at 19:50)</a>:</h4>
<p>Yes, this is a problem with the native ("non-direct") upload API. One of numerous problems with it. *)</p>
<p>Addressing it would not be as easy as checking some HTTP header though. With large uploads in particular, there is likely not going to be any such header advertising the total size of the byte stream. The client is more likely to use chunked encoding for the transfer, where the size header is supplied for each buffer-worth ("chunk") of bytes instead. <br>
What we can do is stop and reject the transfer the moment it reaches the file size limit (or goes over the storage quota); which would still be much better than allowing a giant, potentially filesystem-flooding upload to complete before rejecting it. <br>
From what I understand, we would need to implement our own input streaming (as opposed to using the <a href="http://jakarta.ws.rs">jakarta.ws.rs</a> and icefaces implementations we are using in the API and jsf UI respectively). </p>
<p>*) I dislike the native/basic upload API (<code>/api/datasets/{id}/add</code>) enough that I am considering disabling it on the IQSS prod. instance, now that we have direct upload enabled on all storage volumes.</p>



<a name="542660084"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542660084" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542660084">(Oct 02 2025 at 06:05)</a>:</h4>
<p>With the current implementation, we have no chunked upload support either. The multipart/form-data thing is single file in one go only...</p>



<a name="542660164"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542660164" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542660164">(Oct 02 2025 at 06:06)</a>:</h4>
<p>For chunked uploads we'd need to implement custom handling anyway. There are a few "vendor standards" (Google, AWS, <a href="http://tus.io">tus.io</a>), but not one single concise thing. It boils down to have three additional endpoints: one to initialise a chunked upload, one to upload the chunks themselves and a status check.</p>



<a name="542661963"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542661963" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542661963">(Oct 02 2025 at 06:24)</a>:</h4>
<p>I suppose these days a lot of development in the HTTP world focuses on streaming. HTTP/3 (QUIC) removes the "chunked encoding" altogether and replaces it with stream support. The application doesn't need to deal with the details, this is handled by the stack for you. You just send a "normal" PUT/POST and QUIC takes care of splitting this into streams. Obviously, we can't use that - Payara is at HTTP/2 only. Using something like <a href="http://tus.io">tus.io</a> would give us compatibility with HTTP 1.1 and is at least an open standard (even an active draft with the IETF to become a "real" standard).</p>



<a name="542741616"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542741616" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leo Andreev <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542741616">(Oct 02 2025 at 13:27)</a>:</h4>
<blockquote>
<p>With the current implementation, we have no chunked upload support either. The multipart/form-data thing is single file in one go only...</p>
</blockquote>
<p>Are you referring to the API, or the JSF/IceFaces upload?</p>



<a name="542741789"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542741789" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philip Durbin ðŸš€ <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542741789">(Oct 02 2025 at 13:28)</a>:</h4>
<p>IceFaces takes me back <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="542741943"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542741943" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leo Andreev <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542741943">(Oct 02 2025 at 13:28)</a>:</h4>
<p>Yeah. Ice, prime, same stuff. You know what I meant. :)</p>



<a name="542745355"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542745355" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leo Andreev <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542745355">(Oct 02 2025 at 13:43)</a>:</h4>
<p>If the /add API only supports multipart/form-data (does it really? hmm)... That would mean that it is in fact possible to check the total size header and reject the call early on if it's too large. We would need to reimplement how it's handled (i.e., I'm pretty sure that in the current implementation the API method is only called once the transfer is complete; we'll need to intercept that call earlier). <br>
But, rather than making this API support true streaming/chunked encoding, I would rather deprecate it effectively. I really believe we need to replace or supplement it with an equivalent of the direct upload we are already using for S3; that would allow to stream uploads more efficiently and, most importantly, allow multiple file uploads, using /addFiles (again, similarly to the direct-to-S3 uploads).</p>



<a name="542765344"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542765344" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542765344">(Oct 02 2025 at 15:02)</a>:</h4>
<p>If the JSF upload uses chunks, it's a Primefaces custom thing and protocol. I'm only talking about the /api/datasets/ID/add endpoint.</p>



<a name="542766439"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542766439" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Bertuch <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542766439">(Oct 02 2025 at 15:06)</a>:</h4>
<p>I don't think it's necessary to have an endpoint that allows multiple files at once. But I'd like to see chunked or streamed/multiplexed uploads without S3 being an option, thus making it resumable and faster due to parallel uploads.</p>
<p>The client side would need to implement such a chunked protocol anyway, no problem to make the client iterate over files. (Potentially uploading multiple files in parallel, but within their own "chunk upload session".) </p>
<p>The <a href="http://tus.io">tus.io</a> stuff looks very interesting, I could totally see it using that and not need to rely on out of band uploads. After all, exposing an S3 server on the net is not without risks.</p>



<a name="542776520"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/542776520" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leo Andreev <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#542776520">(Oct 02 2025 at 15:48)</a>:</h4>
<p>When I'm talking about multi-file uploads, again, I'm referring to the model already used for the direct-to-S3 uploads. <br>
You are still uploading one file at a time. You also request the upload authorization for each file, one at a time. Note that you must supply the file size when requesting this pre-signed upload url. So it is very easy to reject an upload request based on size early on, before any bytes are transferred.<br>
But, you can then use one /addFiles call to _finalize_ multiple file uploads to add the datafiles to the dataset, once the physical file transfers have been completed. This is extremely important; because updating the version after every upload (like the /add API does) can become very expensive as the number of files in the dataset grows. <br>
I absolutely want to be able to do something like this for non-S3 uploads.</p>



<a name="543599868"></a>
<h4><a href="https://dataverse.zulipchat.com#narrow/stream/379673-dev/topic/Upload%20checks%20need%20optimization/near/543599868" class="zl"><img src="https://gdcc.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leo Andreev <a href="https://gdcc.github.io/zulip-archive/stream/379673-dev/topic/Upload.20checks.20need.20optimization.html#543599868">(Oct 07 2025 at 18:41)</a>:</h4>
<p>In the spirit of useful incremental improvements, it would be great to start with re-working the "classic" upload API (/add), just so that it can check multipart/form-data headers and reject an over-the-limit uploads without accepting the entire upload first.</p>



<hr><p>Last updated: Nov 01 2025 at 23:12 UTC</p>
</html>